var G_LoadSecurityJs=!1,G_LoadCompressJs=!1,G_LoadCryptoJs=!1;importScripts("raonkupload.base64.js");importScripts("raonkupload.xhr.js");var G_formfeed="\f",G_vertical="\x0B",G_xhr=null,CryptoJS=null,G_MagicJsData={options:null,isLoaded:!1},G_ExtraData=null,G_BandwidthInfo={beforeSize:0};function makeGuidTagName(a){var c=0,e=(new Date).getTime().toString(32),d;for(d=0;5>d;d++)e+=Math.floor(65535*Math.random()).toString(32);return(a||"o_")+e+(c++).toString(32)}
function upload(a){if("1"==a.magicJsData.use&&0==G_MagicJsData.isLoaded){G_MagicJsData.options=a.magicJsData.pluginOptions;for(var c=G_MagicJsData.options.extraJsModules,e=c.length,d=0;d<e;d++)importScripts(c[d]);G_MagicJsData.isLoaded=!0}"1"!=a.security.fileEncrypt&&"2"!=a.security.fileEncrypt&&"2"!=a.security.encryptParam||null!=CryptoJS||importScripts("aes.js");if(null==G_xhr||void 0==G_xhr)G_xhr=new XMLHttpRequest;c=a.handlerUrl;c=-1<c.indexOf("?")?c+("&raonk="+makeGuidTagName("urk_")):c+("?raonk="+
makeGuidTagName("urk_"));G_xhr.open("POST",c,a.asyncUpload);if(a.addHttpHeader)for(var b in a.addHttpHeader)G_xhr.setRequestHeader(b,a.addHttpHeader[b]);var g=a.chunk.size;try{G_xhr.upload.onprogress=function(b){var p=parseInt(b.loaded/b.total*a.chunk.size*1,10),c=G_BandwidthInfo.beforeSize;G_BandwidthInfo.beforeSize=b.loaded;c=b.loaded-c;b.loaded==b.total&&(G_BandwidthInfo.beforeSize=0);self.postMessage({type:"chunkProgress",chunkLoadedSize:p,tickSize:c})}}catch(m){}G_xhr.onreadystatechange=function(){if(4==
G_xhr.readyState)if(200==G_xhr.status){var b=RaonKBase64.parseDataFromServer(G_xhr.responseText);if("[OK]"==b)self.postMessage({type:"progress",paramObj:{uploadedSize:g,workerId:a.workerId,uploadIdx:a.uploadIdx,path:a.path,extraData:G_ExtraData}});else if(0==b.indexOf("[FAIL]")){var b=b.replace("[FAIL]",""),b=RaonKBase64.makeDecryptReponseMessage(b,a.security),b=b.split("|"),p="",c="";0==b.length?c=b[0]:(p=b[0],c=b[1]);self.postMessage({type:"error",code:p,message:c,id:a.id});G_xhr=void 0;self.close()}}else if(400<=
G_xhr.status&&600>G_xhr.status||0==G_xhr.status)self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()};var f="",h=function(){try{G_xhr.send(f),f=void 0}catch(b){self.postMessage({type:"error",code:"C000",message:b.message,workerId:a.workerId}),G_xhr=void 0}};b=""+("kc"+G_formfeed+"c02"+G_vertical);b+="k01"+G_formfeed+a.security.encryptParam+G_vertical;c=a.security.fileEncrypt;"1"==a.magicJsData.use&&"1"==G_MagicJsData.options.encrypt.use&&
(c="1");"0"!=c&&(b+="k02"+G_formfeed+c+G_vertical);b+="k03"+G_formfeed+(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)+G_vertical;"0"!=a.compress&&(b+="k04"+G_formfeed+3+G_vertical);b+="k05"+G_formfeed+a.resumeUpload+G_vertical;b+="k12"+G_formfeed+a.guid+G_vertical;c=!0;d=e=!1;"1"==a.magicJsData.use&&"1"==G_MagicJsData.options.encrypt.use&&(e=!0,"0"==G_MagicJsData.options.encrypt.decryptInServer&&(c=!1,d=!0));c&&(b+="k19"+G_formfeed+a.startPos+G_vertical);
b+="k26"+G_formfeed+a.path;a.cloudInfoUse&&"2"==a.cloudInfoUse&&(b+=G_vertical,b+="k46"+G_formfeed+a.cloudInfoUse+G_vertical,b+="k27"+G_formfeed+a.partNumber+G_vertical,b+="k48"+G_formfeed+a.partSize);e&&(b+=G_vertical,b+="k49"+G_formfeed+"1");d&&(b+=G_vertical,b+="k50"+G_formfeed+"1");"1"==a.useKMonitoring&&(b+=G_vertical+"km00"+G_formfeed+a.trasnferId);b=RaonKBase64.makeEncryptParamFinal(a.security,b);if("undefined"==typeof FormData){var n=makeGuidTagName("----raonk_"),k=function(a){G_xhr&&(G_xhr.setRequestHeader("Content-Type",
"multipart/form-data; boundary="+n),G_xhr.setRequestHeader("RAONK-Encoded","base64"));f=a;h()};try{buildFormData(a,b,n,k)}catch(p){self.postMessage({type:"error",code:"C001",message:p.message,workerId:a.workerId}),G_xhr=void 0}}else{f=new FormData;f.append(b.name,b.value);var l;if("1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)||"0"!=a.compress||"0"!=a.security.fileEncrypt){l=new FileReaderSync;try{k=l.readAsArrayBuffer(a.chunk),l=void 0}catch(t){l=
void 0,self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()}}b="";if("1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)){G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0);try{b=D5FileDataIntegrity(k,a.security.keyValue.substring(0,11),!0).toString()}catch(u){self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+
G_xhr.status,id:a.id}),G_xhr=void 0,self.close()}f.append("k25",b)}var q=function(a){f.append("Slice",a);h()};if("0"!=a.compress)makeZipData(a.uploadIdx,k,function(b){0<a.security.fileEncrypt?(l=new FileReaderSync,newData=l.readAsArrayBuffer(b),l=void 0,encryptFileData(newData,a,q)):(f.append("Slice",b),h())});else if(0<a.security.fileEncrypt)encryptFileData(k,a,q);else if("1"==a.magicJsData.use){l=new FileReaderSync;try{k=l.readAsArrayBuffer(a.chunk),l=void 0}catch(v){l=void 0,self.postMessage({type:"error",
code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()}k={fileArrayBuffer:k,chunkIdx:a.uploadIdx,isLast:a.isLast,magicJsOptions:G_MagicJsData.options,updateExtraData:function(a){if(null==G_ExtraData||null==a)G_ExtraData={};for(data in a)G_ExtraData[data]=a[data]},callback:function(a){a=makeBlob(a);f.append("Slice",a);h()}};try{uploadUsingMagicJs(k)}catch(r){self.postMessage({type:"error",code:"C011",message:r.message||r,workerId:workerId})}}else f.append("Slice",
a.chunk),h()}}self.onmessage=function(a){a=a.data;switch(a.type){case "upload":upload(a.uploadData);break;case "check_formdata":a=!0,"undefined"==typeof FormData&&(a=!1),self.postMessage({type:"check_formdata",isFormDataSupport:a})}};
function buildFormData(a,c,e,d){var b=new FileReaderSync,g=b.readAsDataURL(a.chunk),m=g.match(/,(.*)$/)[1],f,h,n=function(){var a;a=""+("--"+e+'\r\nContent-Disposition: form-data; name="'+c.name+'"');a+="\r\n\r\n";a+=c.value;a+="\r\n";a+="--"+e+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream";a+="\r\n";a+="\r\n";a+=m;a+="\r\n";h&&(a+="--"+e+'\r\nContent-Disposition: form-data; name="k25"',a+="\r\n",a+="\r\n",a+=h,a+="\r\n");
a+="--"+e+"--\r\n";b=g=m=void 0;d(a)};"1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)&&(G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0),f=b.readAsArrayBuffer(a.chunk),h=D5FileDataIntegrity(f,a.security.keyValue,!0).toString());var k=function(a){m=b.readAsDataURL(a).match(/,(.*)$/)[1];n()};"0"!=a.compress?(f||(f=b.readAsArrayBuffer(a.chunk)),makeZipData(a.uploadIdx,f,function(c){0<a.security.fileEncrypt?
encryptFileData(b.readAsArrayBuffer(c),a,k):(m=b.readAsDataURL(c).match(/,(.*)$/)[1],n())})):0<a.security.fileEncrypt?(f||(f=b.readAsArrayBuffer(a.chunk)),encryptFileData(f,a,k)):n()}function makeZipData(a,c,e){G_LoadCompressJs||(importScripts("jszip/jszip.js"),G_LoadCompressJs=!0);var d=new JSZip;d.file(a,c);d.generateAsync({type:"blob",compression:"deflate",compressionOptions:{level:9},comment:"RAONWIZ"},function(a){}).then(function(a){"function"==typeof e&&e(a);d=void 0})}
function encryptFileData(a,c,e){var d;try{d=crypto||msCrypto}catch(b){}var g=c.security.keyValue.substring(0,11),m=16*c.security.fileEncrypt,f=c.workerId;if(d&&d.subtle){var h=stringToBytes(g),g=new Uint8Array(m);g.set(h);c=d.subtle.importKey("raw",g,{name:"AES-CBC"},!1,["encrypt","decrypt"]);c.then(function(b){var c=new Uint8Array(16);c.set(h);d.subtle.encrypt({name:"AES-CBC",iv:c},b,a).then(function(a){a=makeBlob(a);e(a)})["catch"]=function(a){self.postMessage({type:"error",code:"C011",message:a.message||
a,workerId:f})}})["catch"]=function(a){self.postMessage({type:"error",code:"C011",message:a.message||a,workerId:f})}}else G_LoadCryptoJs||(G_LoadSecurityJs||importScripts("raonkupload.fdi.aes.js"),G_LoadCryptoJs=!0),c=CryptoJS.enc.Utf8.parse(g),c.sigBytes=m,wordArrayData=arrayBufferToWordArray(a),g=CryptoJS.AES.encrypt(wordArrayData,c,{iv:CryptoJS.enc.Utf8.parse(g)}),wordArrayData=void 0,g=makeBlob(convertWordArrayToUint8Array(g.ciphertext)),e(g)}
function arrayBufferToBase64(a){var c="";a=new Uint8Array(a);for(var e=a.byteLength,d=0;d<e;d++)c+=String.fromCharCode(a[d]);return btoa(c)}function stringToBytes(a){for(var c,e,d=[],b=0;b<a.length;b++){c=a.charCodeAt(b);e=[];do e.push(c&255),c>>=8;while(c);d=d.concat(e.reverse())}return d}var makeBlob=function(a){var c=[];c.push(a);return new Blob(c,{type:"application/octet-stream"})};function getTickCount(){return(new Date).getTime()};
