<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="custBgtPrdAprvl">

   <!--
    ******************************************************************************
    * SELECT : custBgtByacctAprvl
    * 작성자 : moonjooh
    * 작성 일자 : 2022-03-02
    ******************************************************************************
    -->
    <select id="selectCustBgtPrdAprvl" parameterType="HashMap" resultType="HashMap">
        /* custBgtPrdAprvl.selectCustBgtPrdAprvl 상품결재선 관리 목록 조회 */
         SELECT LST.*
			  , FN_PR_ATTR_VAL_LIST(LST.CO_CD, LST.PRD_ID) AS PRVL																								/* 대표규격 */
			  , FN_PR_FULL_CLSF_NM(LST.CO_CD, (SELECT PRD.PRD_CLCD FROM TB_PR_PRD_INFO PRD WHERE PRD.CO_CD = LST.CO_CD AND PRD.PRD_ID = LST.PRD_ID )) AS CATG 	/* 상품분류코드 */
        	  , LAG(LST.ID_CHK1) OVER (ORDER BY LST.BZPLC_ID, LST.APRVL_SET_SEQ, LST.APRVL_PST_CD, LST.APRV_SEQ) AS ID_CHK2
			  , CASE WHEN LENGTH(LST.APRVR_NM_N) = 2 THEN SUBSTR(LST.APRVR_NM_N,1,1) || LPAD('*',(LENGTH(LST.APRVR_NM_N)-1),'*')
				     WHEN LENGTH(LST.APRVR_NM_N) = 3 THEN SUBSTR(LST.APRVR_NM_N,1,1) || LPAD('*',(LENGTH(LST.APRVR_NM_N)-2),'*') || SUBSTR(LST.APRVR_NM_N,3,1)
				     ELSE SUBSTR(LST.APRVR_NM_N,1,2) || LPAD('*',(LENGTH(LST.APRVR_NM_N)-2),'*')
				END AS APRVR_NM
			  , CASE WHEN LENGTH(LST.UPDPSN_N) = 2 THEN SUBSTR(LST.UPDPSN_N,1,1) || LPAD('*',(LENGTH(LST.UPDPSN_N)-1),'*')
				     WHEN LENGTH(LST.UPDPSN_N) = 3 THEN SUBSTR(LST.UPDPSN_N,1,1) || LPAD('*',(LENGTH(LST.UPDPSN_N)-2),'*') || SUBSTR(LST.UPDPSN_N,3,1)
				     ELSE SUBSTR(LST.UPDPSN_N,1,2) || LPAD('*',(LENGTH(LST.UPDPSN_N)-2),'*')
				END AS UPDPSN
		 FROM(
        <include refid="com.ssp.bo.cc.common.sqlPrefixPagingCamel" />  
        	SELECT LIST.CHK
        		 , LIST.ID_VALUE AS ID_CHK1
        		 , LIST.CO_CD
        		 , LIST.APRVL_SPR_CD
        		 , LIST.APRVL_SET_SEQ
        		 , LIST.BZPLC_ID
        		 , LIST.BZPLC_NM
        		 , LIST.PRD_ID_VIEW
        		 , LIST.PRD_ID
        		 , LIST.PRD_NM
        		 , LIST.MNFR_NO
        		 , LIST.MNFR_NM
        		 , LIST.MRO_PRD_CLCD
        		 , LIST.ORGPLC_CTRY_CD
        		 , TO_NUMBER(LIST.APRV_SEQ) AS APRV_SEQ
        		 , LIST.APRVR_ID
        		 , LIST.APRVR_NM AS APRVR_NM_N
        		 , LIST.APRVL_PST_CD
        		 , LIST.UPDPSN AS UPDPSN_ID
        		 , NVL(M.OPRTR_NM, M2.MBR_NM) AS UPDPSN_N
        		 , LIST.UPD_DTM
        	FROM(
        		SELECT '0' AS CHK
	        		 , APR.CO_CD										/* 회사코드 */
        			 , APR.CO_CD || APR.BZPLC_ID || APR.APRVL_SPR_CD || APR.APRVL_SET_SEQ AS ID_VALUE
	        		 , APR.APRVL_SPR_CD									/* 결재선구분코드 */
					 , APR.APRVL_SET_SEQ								/* 결재선설정순번 */
					 , APR.BZPLC_ID										/* 사업장ID */
					 , BZP.BZPLC_NM 									/* 사업장명 */
				 	 , TO_NUMBER(APR.PRD_ID) PRD_ID_VIEW				/* 상품ID */
					 , APR.PRD_ID										/* 상품ID */
        		 	 , (SELECT P.PRD_NM FROM TB_PR_PRD_INFO P WHERE P.CO_CD = APR.CO_CD AND P.PRD_ID = APR.PRD_ID ) PRD_NM /* 상품명 */
					 , MRO_PRD.MNFR_NO									/* 제조사번호 */
					 , MNFR.MNFR_NM 									/* 제조사명 */
					 , MRO_PRD.MRO_PRD_CLCD
					 , CTRY.CTRY_NM AS ORGPLC_CTRY_CD					/* 원산지 국가코드 */
					 , CASE WHEN APRSET.APRV_SEQ > 90000 
					 			THEN APRSET.APRV_SEQ-90000
						 	ELSE APRSET.APRV_SEQ
					   END AS APRV_SEQ									/* 결재 차수 */
					 , APRSET.APRVR_ID
					 , NVL( M.MBR_NM, APRSET.APRVR_ID ) AS APRVR_NM		/* 결재자 */
					 , APRSET.APRVL_PST_CD								/* 최초/최종 */
					 , NVL(APR.UPDPSN_ID, APR.REGPSN_ID) AS UPDPSN		/* 최종변경자 */
					 , NVL(APR.UPD_DTM, APR.REG_DTM) AS UPD_DTM			/* 최종변경일시 */
				FROM TB_CC_APRVL_SET_INFO APR
				<if test=" bzplcId > 0 ">
		            JOIN
		            TB_OD_ODR_INQ_TGT_DTLS   T1
		            ON  T1.SES_ID = #{sesId}
		            AND T1.INQ_COND_DTLS = #{inqCondDtls}
		            AND T1.COL_ITM = 'BZPLC_ID'
		            AND T1.COND_DATA_VAL = APR.BZPLC_ID
	            </if>
				<if test=" prdId > 0 ">
		            JOIN
		            TB_OD_ODR_INQ_TGT_DTLS   T2
		            ON  T2.SES_ID = #{sesId}
		            AND T2.INQ_COND_DTLS = #{inqCondDtls}
		            AND T2.COL_ITM = 'PRD_ID'
		            AND LPAD(T2.COND_DATA_VAL,18,'0') = APR.PRD_ID
	            </if>
				LEFT OUTER JOIN TB_CC_BZPLC_BASIS BZP
						ON BZP.CO_CD = APR.CO_CD 
						AND BZP.BZPLC_ID = APR.BZPLC_ID
				LEFT OUTER JOIN TB_PR_MRO_PRD_INFO MRO_PRD
						ON MRO_PRD.CO_CD = APR.CO_CD
						AND MRO_PRD.PRD_ID = APR.PRD_ID
				LEFT OUTER JOIN TB_CC_APRVL_SET_DTL APRSET
						ON APRSET.CO_CD = APR.CO_CD 
						AND APRSET.BZPLC_ID = APR.BZPLC_ID
						AND APRSET.APRVL_SPR_CD = APR.APRVL_SPR_CD
						AND APRSET.APRVL_SET_SEQ = APR.APRVL_SET_SEQ
				LEFT OUTER JOIN TB_PR_MNFR_INFO MNFR
						ON MNFR.CO_CD = APR.CO_CD
						AND MNFR.MNFR_NO = MRO_PRD.MNFR_NO
				LEFT OUTER JOIN TB_CO_CTRY_INFO CTRY
						ON CTRY.CO_CD = MRO_PRD.CO_CD
						AND CTRY.CTRY_SPR_CD = MRO_PRD.ORGPLC_CTRY_CD
				LEFT OUTER JOIN TB_CC_MBR_BASIS M
						ON M.CO_CD = APRSET.CO_CD
					 	AND M.MBR_ID = APRSET.APRVR_ID
				WHERE APR.APRVL_SPR_CD = '20'
					AND APR.USE_YN = 'Y'
				ORDER BY BZPLC_ID, PRD_ID, APRVL_SET_SEQ, APRVL_PST_CD, APRV_SEQ
        	)LIST
			<if test=" acctId > 0 ">
		        JOIN
		        TB_OD_ODR_INQ_TGT_DTLS   T3
		        ON  T3.SES_ID = #{sesId}
		        AND T3.INQ_COND_DTLS = #{inqCondDtls}
		        AND T3.COL_ITM = 'ACCT_ID'
		        AND T3.COND_DATA_VAL = LIST.APRVR_ID
	        </if>
	        LEFT OUTER JOIN TB_CO_MBR_OPRTR_INFO M
	        	ON ( M.CO_CD = LIST.CO_CD AND M.OPRTR_ID = LIST.UPDPSN )
	        LEFT OUTER JOIN TB_CC_MBR_BASIS M2
	        	ON ( M2.CO_CD = LIST.CO_CD AND M2.MBR_ID = LIST.UPDPSN )
			<if test="sortColumn != null and sortColumn != '' and sortColumn != 'PRVL' and sortColumn != 'CATG'"> 
		    ORDER BY ${sortColumn} ${sortType} , BZPLC_ID, PRD_ID, APRVL_SET_SEQ, APRVL_PST_CD, APRV_SEQ
		    </if> 
		    <if test="sortColumn == null or sortColumn == '' or sortColumn == 'PRVL' or sortColumn == 'CATG'"> 
			ORDER BY BZPLC_ID, PRD_ID, APRVL_SET_SEQ, APRVL_PST_CD, APRV_SEQ
		    </if>
        <include refid="com.ssp.bo.cc.common.sqlPostfixPagingCamel" />
         ) LST
    </select>
    
    <update id="deleteCustBgtPrdAprvl" parameterType="HashMap">
        /* custBgtPrdAprvl.deleteCustBgtPrdAprvl 계정별 결재선 관리 삭제 */
		DELETE FROM TB_CC_APRVL_SET_INFO
		 WHERE CO_CD = #{coCd}
		   AND BZPLC_ID = #{bzplcId}
		   AND APRVL_SPR_CD = #{aprvlSprCd}
		   AND APRVL_SET_SEQ = #{aprvlSetSeq}
	</update>
	
	<update id="updateCustBgtPrdAprvl" parameterType="HashMap">
        /* custBgtPrdAprvl.updateCustBgtPrdAprvl 계정별 결재선 관리 수정 */
		UPDATE TB_CC_APRVL_SET_INFO
		   SET UPDPSN_ID = #{oprtrId}
		   	 , UPD_DTM = SYSDATE
		 WHERE CO_CD = #{coCd}
		   AND BZPLC_ID = #{bzplcId}
		   AND APRVL_SPR_CD = #{aprvlSprCd}
		   AND APRVL_SET_SEQ = #{aprvlSetSeq}
	</update>
	
	<delete id="deleteCustBgtPrdAprvlDetail" parameterType="HashMap">
		/* custBgtPrdAprvl.deleteCustBgtPrdAprvlDetail 계정별 결재선 관리 결재선정보 삭제 */
		DELETE FROM TB_CC_APRVL_SET_DTL 
		 WHERE CO_CD = #{coCd}
		 AND BZPLC_ID = #{bzplcId}
		 AND APRVL_SPR_CD = #{aprvlSprCd}
		 AND APRVL_SET_SEQ = #{aprvlSetSeq}
	</delete>
	
	<select id="selectPrdInfoByPrdId" parameterType="HashMap" resultType="HashMap">
        /* custBgtPrdAprvl.selectPrdInfoByPrdId 상품 상세정보 조회 */
        SELECT PRD.CO_CD											
        	 , #{bzplcId} AS BZPLC_ID								/* 사업장ID */
			 , #{bzplcNm} AS BZPLC_NM								/* 사업장명 */
			 , #{prdIdView} AS PRD_ID_VIEW							/* 상품ID */
			 , #{prdId} AS PRD_ID									/* 상품ID */
			 , #{prdNm} AS PRD_NM									/* 상품명 */
			 , FN_PR_ATTR_VAL_LIST(#{coCd}, PRD.PRD_ID) AS PRVL		/* 대표규격 */
			 , FN_PR_FULL_CLSF_NM(#{coCd}, PRD.PRD_CLCD) AS CATG	/* 상품분류코드 */
			 , MNFR.MNFR_NM 										/* 제조사명 */
			 , CTRY.CTRY_NM AS ORGPLC_CTRY_CD						/* 원산지 국가코드 */
		FROM TB_PR_PRD_INFO PRD
		LEFT OUTER JOIN TB_PR_MRO_PRD_INFO MRO_PRD
			ON MRO_PRD.CO_CD = PRD.CO_CD
			AND MRO_PRD.PRD_ID = PRD.PRD_ID
		LEFT OUTER JOIN TB_PR_MNFR_INFO MNFR
			ON MNFR.CO_CD = PRD.CO_CD
			AND MNFR.MNFR_NO = MRO_PRD.MNFR_NO
		LEFT OUTER JOIN TB_CO_CTRY_INFO CTRY
			ON CTRY.CO_CD = PRD.CO_CD
			AND CTRY.CTRY_SPR_CD  = MRO_PRD.ORGPLC_CTRY_CD
		WHERE PRD.PRD_ID = #{prdId}
    </select>
    
    <select id="selectAprvlSetSeq" parameterType="HashMap" resultType="int" flushCache="true" useCache="false">
        /* custBgtPrdAprvl.selectAprvlSetSeq 생성된 결재선 관리 상세 관리정보 APRVL_SET_SEQ 채번 */
        SELECT NVL(MAX(APRVL_SET_SEQ)+1, 1)
		  FROM TB_CC_APRVL_SET_DTL
	     WHERE CO_CD = #{coCd}
		   AND BZPLC_ID = #{bzplcId}
		   AND APRVL_SPR_CD = '20'
    </select>
    
    <select id="selectInsertValidationCheck" parameterType="HashMap" resultType="int">
        /* custBgtPrdAprvl.selectInsertValidationCheck  insert validation */
        SELECT COUNT(*) 
		  FROM TB_CC_APRVL_SET_INFO
		 WHERE CO_CD = #{coCd}
		   AND BZPLC_ID = #{bzplcId}
		   AND APRVL_SPR_CD = #{aprvlSprCd}
		   AND PRD_ID = #{prdId}
    </select>
    
    <insert id="savePrdAprvlInfo" parameterType="HashMap">
        /* custBgtPrdAprvl.savePrdAprvlInfo 계정별 결재선 관리 상세 관리정보 생성 */
		INSERT INTO TB_CC_APRVL_SET_INFO(
        	CO_CD
		 	, BZPLC_ID 
		 	, APRVL_SPR_CD
		 	, APRVL_SET_SEQ
		   	, PRD_ID
		   	, USE_YN
			, REGPSN_ID
			, REG_DTM
        )VALUES(
        	#{coCd}
        	, #{bzplcId}
        	, #{aprvlSprCd}
        	, #{aprvlSetSeq}
        	, #{prdId}
        	, #{useYn}
        	, #{oprtrId}
        	, SYSDATE
		)
	</insert>
	
	<insert id="savePrdAprvlInfoHist" parameterType="HashMap">
        /* custBgtPrdAprvl.savePrdAprvlInfoHist 계정별 결재선 관리 상세 관리정보 이력 */
		INSERT INTO TB_CC_APRVL_SET_INFO_HST(
        	CO_CD
			, BZPLC_ID
			, APRVL_SPR_CD
			, APRVL_SET_SEQ
			, HST_SEQ
			, HST_SPR_CD
			, PRD_ID
			, USE_YN
			, REGPSN_ID
			, REG_DTM
			, UPDPSN_ID
			, UPD_DTM
        )
        SELECT A.CO_CD
			 , A.BZPLC_ID
			 , A.APRVL_SPR_CD
			 , A.APRVL_SET_SEQ
			 , (
        		SELECT NVL(MAX(HST_SEQ), 0)+1
				FROM TB_CC_APRVL_SET_INFO_HST
				WHERE CO_CD = #{coCd}
				AND BZPLC_ID = #{bzplcId}
				AND APRVL_SPR_CD = #{aprvlSprCd}
				AND APRVL_SET_SEQ = #{aprvlSetSeq}
        	 )
			 , #{hstSprCd}
			 , A.PRD_ID
			 , A.USE_YN
			 , A.REGPSN_ID
			 , A.REG_DTM
			 , A.UPDPSN_ID
			 , A.UPD_DTM
		  FROM TB_CC_APRVL_SET_INFO A
		 WHERE A.CO_CD = #{coCd}
		   AND A.BZPLC_ID = #{bzplcId}
		   AND A.APRVL_SPR_CD = #{aprvlSprCd}
		   AND A.APRVL_SET_SEQ = #{aprvlSetSeq}
	</insert>
	
	<insert id="insertPopApr" parameterType="HashMap">
        /* custBgtPrdAprvl.insertPopApr 상품별 결재선 관리 상세 결재선정보 생성 */
		INSERT INTO TB_CC_APRVL_SET_DTL(
        	CO_CD
		 	, BZPLC_ID 
		 	, APRVL_SPR_CD
		 	, APRVL_SET_SEQ
		 	, APRV_SEQ
			, APRVL_PST_CD
			, APRVR_ID
			, REGPSN_ID
			, REG_DTM
        )VALUES(
        	#{coCd}
        	, #{bzplcId}
        	, #{aprvlSprCd}
        	, #{aprvlSetSeq}
        	, #{dgrCnt}
        	, #{aprvlPstCd}
        	, #{mbrId}
        	, #{oprtrId}
        	, SYSDATE
		)
	</insert>
	
	<insert id="savePrdAprvlInfoHistForDelete" parameterType="HashMap">
        /* custBgtPrdAprvl.savePrdAprvlInfoHistForDelete 상품별 결재선 관리 상세 결재선정보 이력 */
		INSERT INTO TB_CC_APRVL_SET_DTL_HST(
        	CO_CD
			, BZPLC_ID
			, APRVL_SPR_CD
			, APRVL_SET_SEQ
			, APRV_SEQ
			, HST_SEQ
			, HST_SPR_CD
			, APRVL_PST_CD
			, APRVR_ID
			, REGPSN_ID
			, REG_DTM
			, UPDPSN_ID
			, UPD_DTM
        )
        SELECT A.CO_CD
			 , A.BZPLC_ID
			 , A.APRVL_SPR_CD
			 , A.APRVL_SET_SEQ
			 , A.APRV_SEQ
			 , (
        		SELECT NVL(MAX(HST_SEQ), 0)+1
				FROM TB_CC_APRVL_SET_DTL_HST
				WHERE CO_CD = #{coCd}
				AND BZPLC_ID = #{bzplcId}
				AND APRVL_SPR_CD = #{aprvlSprCd}
				AND APRVL_SET_SEQ = #{aprvlSetSeq}
        	 )
			 , #{hstSprCd}
			 , A.APRVL_PST_CD
			 , A.APRVR_ID
			 , A.REGPSN_ID
			 , A.REG_DTM
			 , A.UPDPSN_ID
			 , A.UPD_DTM
		  FROM TB_CC_APRVL_SET_DTL A
		 WHERE A.CO_CD = #{coCd}
		   AND A.BZPLC_ID = #{bzplcId}
		   AND A.APRVL_SPR_CD = #{aprvlSprCd}
		   AND A.APRVL_SET_SEQ = #{aprvlSetSeq}
	</insert>
	
	<update id="updatePopApr" parameterType="HashMap">
        /* custBgtPrdAprvl.updatePopApr 결재선 관리 상세 결재선정보 수정 */
        MERGE INTO TB_CC_APRVL_SET_DTL
		USING DUAL 
		ON ( CO_CD = #{coCd}
		 AND BZPLC_ID = #{bzplcId}
		 AND APRVL_SPR_CD = #{aprvlSprCd}
		 AND APRVL_SET_SEQ = #{aprvlSetSeq}
		 AND APRV_SEQ = #{dgrCnt}
		)
		WHEN MATCHED THEN
		UPDATE SET APRVR_ID = #{mbrId}
		     , APRVL_PST_CD = #{aprvlPstCd}
		   	 , UPDPSN_ID = #{oprtrId}
		   	 , UPD_DTM = SYSDATE
		WHEN NOT MATCHED THEN
        INSERT(
        	CO_CD
		 	, BZPLC_ID 
		 	, APRVL_SPR_CD
		 	, APRVL_SET_SEQ
		 	, APRV_SEQ
			, APRVL_PST_CD
			, APRVR_ID
			, REGPSN_ID
			, REG_DTM
        )VALUES(
        	#{coCd}
        	, #{bzplcId}
        	, #{aprvlSprCd}
        	, #{aprvlSetSeq}
        	, #{dgrCnt}
        	, #{aprvlPstCd}
        	, #{mbrId}
        	, #{oprtrId}
        	, SYSDATE
		)
    </update>
    
    <delete id="deletePopApr" parameterType="HashMap">
		/* custBgtPrdAprvl.deletePopApr 결재선 관리 상세 결재선정보 Delete */
		DELETE FROM TB_CC_APRVL_SET_DTL 
		 WHERE CO_CD = #{coCd}
		 AND BZPLC_ID = #{bzplcId}
		 AND APRVL_SPR_CD = #{aprvlSprCd}
		 AND APRVL_SET_SEQ = #{aprvlSetSeq}
	</delete>
	
	<select id="selectPopAprDetail" parameterType="HashMap" resultType="HashMap">
        /* custBgtPrdAprvl.selectPopAprDetail 계정별 결재선 관리 상세 결재선조회 */
        SELECT CASE WHEN APRV_SEQ > 90000 THEN APRV_SEQ-90000||''
			       ELSE APRV_SEQ||''
			   END AS DGR_CNT								/* 결재 차수 */
			 , APRVR_ID AS MBR_ID							/* 결재자ID */
			 , (SELECT M.MBR_NM
				  FROM TB_CC_MBR_BASIS M
				 WHERE M.CO_CD = CO_CD
				   AND M.MBR_ID = APRVR_ID) AS MBR_NM		/* 결재자명 */
			 , APRVL_PST_CD									/* 최초/최종 */
			 , '0' AS CHK
			 , #{coCd} AS CO_CD
			 , #{bzplcId} AS BZPLC_ID
			 , APRVL_SPR_CD									/* 결재선구분코드 */
			 , APRVL_SET_SEQ								/* 결재선설정순번 */
			 , ROWNUM||'' AS GROW
		  FROM TB_CC_APRVL_SET_DTL
		 WHERE CO_CD = #{coCd}
		   AND BZPLC_ID = #{bzplcId}
		   AND APRVL_SPR_CD = #{aprvlSprCd}
		   AND APRVL_SET_SEQ = #{aprvlSetSeq}
    </select>
    
    <select id="selectPopAprInfo" parameterType="HashMap" resultType="HashMap">
        /* custBgtPrdAprvl.selectPopAprInfo 상품별 결재선 관리 정보 코드조회 */
        SELECT CO_CD 
			 , BZPLC_ID 
			 , APRVL_SPR_CD 
			 , APRVL_SET_SEQ 
		  FROM TB_CC_APRVL_SET_INFO
		 WHERE CO_CD = #{coCd}
		   AND BZPLC_ID = #{bzplcId}
		   AND APRVL_SPR_CD = '20'
		   AND PRD_ID = #{prdId}
		   AND ROWNUM = 1
    </select>
    
</mapper>