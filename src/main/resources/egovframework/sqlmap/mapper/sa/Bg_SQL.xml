<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Bg">

<!--
	******************************************************************************
	* SELECT : 배지
	* 작성자 : 87minho
	* 작성 일자 : 2022-02-23
	******************************************************************************
	-->
	<select id="selectBgListCnt" parameterType="HashMap" resultType="Integer">
		/* 배지 목록 총 합계 - Bg_SQL.selectBgListCnt */
		SELECT COUNT(1)
		FROM SSP_APP.TB_SA_BG_INFO
		WHERE CO_CD = #{coCd}
		<if test="bgNm != null and !bgNm.equals('') ">
			AND BG_NM LIKE '%' || #{bgNm} || '%'
		</if>
		<if test="regpsnId != null and !regpsnId.equals('') ">
			AND REGPSN_ID = #{regpsnId}
		</if>
		<if test="useYn != null and !useYn.equals('') ">
			AND USE_YN = #{useYn}
		</if>
		<if test="fromDate != null and !fromDate.equals('') ">
			AND REG_DTM >=  TO_DATE(#{fromDate}, 'YYYYMMDD')
		</if>
		<if test="toDate != null and !toDate.equals('') ">
			AND REG_DTM <![CDATA[ < ]]> TO_DATE(#{toDate}, 'YYYYMMDD') + 1
		</if>
		<if test="bgWgtYn != null and !bgWgtYn.equals('') ">
			AND BG_WGT_YN = #{bgWgtYn}
		</if>
	</select>

	<select id="selectBgList" parameterType="HashMap" resultType="HashMap">
		/* 배지 목록 조회 - Bg_SQL.selectBgList */
		SELECT A.CO_CD
					, A.BG_SEQ
					, A.BG_NM
					, A.DOC_REG_ID
					, B.DOC_REG_SEQ
					, #{ssoServiceUrl} AS SSO_SVCE_URL
					, A.USE_YN
					, A.REGPSN_ID
					, C.OPRTR_NM AS REGPSN_NM
					, TO_CHAR(A.REG_DTM, 'YYYY-MM-DD') AS REG_DTM
					, A.BG_WGT_YN
		FROM TB_SA_BG_INFO A
					, TB_CO_ATFL_DTLS B
					, TB_CO_MBR_OPRTR_INFO C
		WHERE A.DOC_REG_ID = B.DOC_REG_ID(+)
		AND A.CO_CD = C.CO_CD(+)
		AND A.REGPSN_ID = C.OPRTR_ID(+)
		AND A.CO_CD = #{coCd}
		<if test="bgNm != null and !bgNm.equals('') ">
			AND A.BG_NM LIKE '%' || #{bgNm} || '%'
		</if>
		<if test="regpsnId != null and !regpsnId.equals('') ">
			AND A.REGPSN_ID = #{regpsnId}
		</if>
		<if test="useYn != null and !useYn.equals('') ">
			AND A.USE_YN = #{useYn}
		</if>
		<if test="fromDate != null and !fromDate.equals('') ">
			AND A.REG_DTM >=  TO_DATE(#{fromDate}, 'YYYYMMDD')
		</if>
		<if test="toDate != null and !toDate.equals('') ">
			AND A.REG_DTM <![CDATA[ < ]]> TO_DATE(#{toDate}, 'YYYYMMDD') + 1
		</if>
		<if test="bgWgtYn != null and !bgWgtYn.equals('') ">
			AND BG_WGT_YN = #{bgWgtYn}
		</if>
		<if test="sortColumn != null and sortColumn != ''">
		ORDER BY ${sortColumn} ${sortType}
		</if>
		<if test="sortColumn == null or sortColumn == ''">
		ORDER BY A.USE_YN DESC, A.REG_DTM DESC
		</if>
		OFFSET #{startNum} ROWS FETCH FIRST #{rowCount} ROWS ONLY
	</select>

	<select id="selectBgDetail" parameterType="HashMap" resultType="HashMap">
		/* 배지 상세 조회 - Bg_SQL.selectBgDetail */
		SELECT A.CO_CD
					, A.BG_SEQ
					, A.BG_NM
					, A.DOC_REG_ID
					, A.USE_YN
					, A.REGPSN_ID
					, C.OPRTR_NM AS REGPSN_NM
					, TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
					, A.UPDPSN_ID
					, D.OPRTR_NM AS UPDPSN_NM
					, TO_CHAR(A.UPD_DTM, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DTM
					, B.ATFL_NM
					, B.ATFL_STOR_PATH
					, B.ORI_ATFL_NM
					, B.DOC_REG_SEQ
					, A.BG_WGT_YN
		FROM TB_SA_BG_INFO A
			, TB_CO_ATFL_DTLS B
			, TB_CO_MBR_OPRTR_INFO C
			, TB_CO_MBR_OPRTR_INFO D
		WHERE A.DOC_REG_ID = B.DOC_REG_ID(+)
			AND A.CO_CD = C.CO_CD(+)
			AND A.REGPSN_ID = C.OPRTR_ID(+)
			AND A.CO_CD = D.CO_CD(+)
			AND A.UPDPSN_ID = D.OPRTR_ID(+)
			AND A.CO_CD = #{coCd}
			AND A.BG_SEQ = #{bgSeq}
	</select>

	<insert id="insertBgDetail" parameterType="hashMap">
		/* 배지 상세 등록 - Bg_SQL.insertBgDetail */
		<selectKey keyProperty="bgSeq" resultType="Integer" order="BEFORE">
			SELECT SQ_SA_BG_INFO_01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO SSP_APP.TB_SA_BG_INFO
		(
			CO_CD
			, BG_SEQ
			, BG_NM
			, DOC_REG_ID
			, USE_YN
			, REGPSN_ID
			, REG_DTM
			, UPDPSN_ID
			, UPD_DTM
			, BG_WGT_YN
		) VALUES
		(
			#{coCd}
			, #{bgSeq}
			, #{bgNm}
			, #{docRegId}
			, #{useYn}
			, #{regpsnId}
			, SYSDATE
			, #{updpsnId}
			, SYSDATE
			, #{bgWgtYn}
		)
	</insert>

	<update id="updateBgDetail" parameterType="hashMap">
		/* 배지 상세 수정 - Bg_SQL.updateBgDetail */
		UPDATE
			SSP_APP.TB_SA_BG_INFO
		SET
		BG_NM  = #{bgNm}
			, DOC_REG_ID = #{docRegId}
			, USE_YN = #{useYn}
			, UPD_DTM = SYSDATE
			, UPDPSN_ID = #{updpsnId}
			, BG_WGT_YN = #{bgWgtYn} 
		WHERE CO_CD = #{coCd}
			AND BG_SEQ = #{bgSeq}
	</update>

	<select id="selectBgPrdAplyCnt" parameterType="HashMap" resultType="HashMap">
		/* 상품에 배지 적용된 개수 조회 - Bg_SQL.selectBgPrdAplyCnt */
		SELECT COUNT(1) AS CNT
		FROM SSP_APP.TB_PR_PRD_INFO
		WHERE CO_CD = #{coCd}
			AND BG_SEQ = #{bgSeq}
	</select>

	<delete id="deleteBgDetail" parameterType="hashMap">
		/* 배지 상세 삭제 - Bg_SQL.deleteBgDetail */
		DELETE FROM SSP_APP.TB_SA_BG_INFO
		WHERE CO_CD = #{coCd}
			AND BG_SEQ = #{bgSeq}
	</delete>

</mapper>