<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="RdattrProc">

	<!--
    ******************************************************************************
    * SELECT : R&D속성 목록 조회
    * 작성자 : 김진섭
    * 작성 일자 : 2022.03.11
    ******************************************************************************
    -->
    <select id="selectPropertyList" parameterType="HashMap" resultType="HashMap">
        /* RdattrProc.selectPropertyList      RdattrProc_SQL.xml */
		SELECT A.CO_CD
		     , A.PRD_ATTR_CD
		     , A.MALL_SPR_CD
		     , A.PRNM
		     , A.USE_YN
		     , TO_CHAR(A.REG_DTM, 'YYYY.MM.DD HH24:MI:SS') AS REG_DTM
		     , TO_CHAR(A.UPD_DTM, 'YYYY.MM.DD HH24:MI:SS') AS UPD_DTM
		     , COUNT(B.PRD_ATTR_CD)                        AS ATTR_CNT
		FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
		   , SSP_APP.TB_PR_PRD_INFO_ATTR_MAPP B
		WHERE 1 = 1
		
	      AND A.MALL_SPR_CD = '20' /*10:SSP, 20:RND*/
          AND A.PRD_ATTR_CD = B.PRD_ATTR_CD(+)
	    
	    <if test="attrNmArr != null and attrNmArr.length > 0">
	        AND A.PRNM IN
	    	<foreach collection="attrNmArr" item="attrNmArr" open="(" close=")" separator=",">
	        	#{attrNmArr}
	        </foreach>
	    </if>
	    
	    <if test="attrCdArr != null and attrCdArr.length > 0">
	        AND A.PRD_ATTR_CD IN
	    	<foreach collection="attrCdArr" item="attrCdArr" open="(" close=")" separator=",">
	        	#{attrCdArr}
	        </foreach>
	    </if>
	    
	    <if test="USE_YN != null and USE_YN != ''">
	       AND A.USE_YN = #{USE_YN}
	    </if>
	    <if test="START_DT != null and START_DT != ''">
	       <choose>
                <when test="CAL_GUBUN == '10'">
                    AND TO_CHAR(A.REG_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
                </when>
                <otherwise>
                    AND TO_CHAR(A.UPD_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
                </otherwise>
           </choose>
	    </if>
	    
	    GROUP BY A.CO_CD
		       , A.PRD_ATTR_CD
		       , A.MALL_SPR_CD
		       , A.PRNM
		       , A.USE_YN
		       , A.REG_DTM
		       , A.UPD_DTM
		<choose>
            <when test="SORT_COLUMN != null and SORT_COLUMN != ''">
                ORDER BY ${SORT_COLUMN} ${SORT_TYPE}
            </when>
            <otherwise>
                ORDER BY A.PRD_ATTR_CD DESC
            </otherwise>
        </choose>
		OFFSET #{START_NUM} ROWS FETCH FIRST #{ROW_COUNT} ROWS ONLY 
    </select>
    
    <select id="selectPropertyCount" parameterType="HashMap" resultType="integer">
        /* RdattrProc.selectPropertyCount      RdattrProc_SQL.xml */
		SELECT COUNT(0)
		FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
		   , SSP_APP.TB_PR_PRD_INFO_ATTR_MAPP B
		WHERE 1 = 1
		
	   AND A.MALL_SPR_CD = '20' /*10:SSP, 20:RND*/
          AND A.PRD_ATTR_CD = B.PRD_ATTR_CD(+)
	    
	    <if test="attrNmArr != null and attrNmArr.length > 0">
	        AND A.PRNM IN
	    	<foreach collection="attrNmArr" item="attrNmArr" open="(" close=")" separator=",">
	        	#{attrNmArr}
	        </foreach>
	    </if>
	    
	    <if test="attrCdArr != null and attrCdArr.length > 0">
	        AND A.PRD_ATTR_CD IN
	    	<foreach collection="attrCdArr" item="attrCdArr" open="(" close=")" separator=",">
	        	#{attrCdArr}
	        </foreach>
	    </if>

	    <if test="USE_YN != null and USE_YN != ''">
	       AND A.USE_YN = #{USE_YN}
	    </if>
	    <if test="START_DT != null and START_DT != ''">
	       <choose>
                <when test="CAL_GUBUN == '10'">
                    AND TO_CHAR(A.REG_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
                </when>
                <otherwise>
                    AND TO_CHAR(A.UPD_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
                </otherwise>
           </choose>
	    </if>
        
        
    </select>
    
     <select id="selectProperty" parameterType="HashMap" resultType="HashMap">
        /* RdattrProc.selectProperty     RdattrProc_SQL.xml */
		SELECT A.CO_CD
             , A.PRD_ATTR_CD
             , A.MALL_SPR_CD
             , A.PRNM
             , A.USE_YN
             , TO_CHAR(A.REG_DTM, 'YYYY.MM.DD HH24:MI:SS') AS REG_DTM
             , TO_CHAR(A.UPD_DTM, 'YYYY.MM.DD HH24:MI:SS') AS UPD_DTM
             , COUNT(B.PRD_ATTR_CD)                        AS ATTR_CNT
        FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
           , SSP_APP.TB_PR_PRD_INFO_ATTR_MAPP B
        WHERE 1 = 1
          AND A.PRD_ATTR_CD = B.PRD_ATTR_CD(+)
		  AND A.CO_CD   = #{CO_CD}
		  AND A.PRD_ATTR_CD = #{PRD_ATTR_CD}    
		GROUP BY A.CO_CD
               , A.PRD_ATTR_CD
               , A.MALL_SPR_CD
               , A.PRNM
               , A.USE_YN
               , A.REG_DTM
               , A.UPD_DTM  
    </select> 
    
    <insert id="insertProperty" parameterType="HashMap">
        /* RdattrProc.insertProperty     RdattrProc_SQL.xml */
		INSERT INTO SSP_APP.TB_PR_PRD_ATTR_INFO (
		      CO_CD
		    , PRD_ATTR_CD
		    , MALL_SPR_CD
		    , PRNM
		    , USE_YN
		    , REG_DTM
		    , REGPSN_ID
		) VALUES (
		      #{CO_CD}
		    , (SELECT  'RP'|| LPAD(TO_CHAR(NVL(MAX(SUBSTR(PRD_ATTR_CD,3,3)),0) + 1),3,'0')
				FROM SSP_APP.TB_PR_PRD_ATTR_INFO 
				WHERE 1=1
				AND SUBSTR(prd_attr_cd,1,2) = 'RP')
		          /*일단 현재 TABLE에 5자리여서 숫자 0을 하나빼고 생성함. TODO 6자리로_20220311*/ 
		    , #{MALL_SPR_CD}
		    , #{PRNM}
		    , #{USE_YN}
		    , SYSDATE
		    , #{USER_ID}
		)    
    </insert> 
    
    <update id="updateProperty" parameterType="HashMap">
        /* RdattrProc.updateProperty      RdattrProc_SQL.xml */
		UPDATE SSP_APP.TB_PR_PRD_ATTR_INFO
		   SET PRNM           = #{PRNM}
		     , USE_YN         = #{USE_YN}
		     , UPD_DTM        = SYSDATE
		     , UPDPSN_ID      = #{USER_ID}
		 WHERE CO_CD          = #{CO_CD}
		   AND PRD_ATTR_CD    = #{PRD_ATTR_CD}
		   AND MALL_SPR_CD  = '20' /*MALL구분*/    
    </update>
    
     <select id="selectRdAttrDuplicateCheck" parameterType="HashMap" resultType="String">
     /* RdattrProc.selectRdAttrDuplicateCheck    RdattrProc_SQL.xml */
     SELECT
         COUNT(*)
     FROM
         SSP_APP.TB_PR_PRD_ATTR_INFO 
         WHERE CO_CD = #{CO_CD}
         AND MALL_SPR_CD = '20' /*몰구분코드*/
         AND PRNM = #{PRNM}
         AND USE_YN  = 'Y'
           
    </select>
     
    
</mapper>