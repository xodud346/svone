<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="NewPrdMltReqLst">
	<select id="selectNewPrdMltReqLst" parameterType="HashMap"
		resultType="HashMap">
		/* NewPrdMltReqLst.selectNewPrdMltReqLst 신규상품일괄요청처리 조회 */
		SELECT
			'0' AS CHK
			, A.CO_CD
			, A.NEW_PRD_REQ_GRP_NO
			, A.CONT_NO
			, A.CONT_CHG_DGRCNT
			, A.EXCEL_DOC_REG_ID
			, A.IMG_DOC_REG_ID
			, A.MSDS_DOC_REG_ID
			, A.REQ_SBJ_CD
			, A.NEW_PRD_REQ_STATS_CD
			, (SELECT FN_RD_DTL_CDNM('KO','NEW_PRD_REQ_STATS_CD', A.NEW_PRD_REQ_STATS_CD) FROM DUAL) AS NEW_PRD_REQ_STATS_NM
			, A.PRD_REG_DIS_TP_CD
			, (select COM_DTL_CD_NM from SSP_APP.TB_CO_COM_CD_DTL
				where COM_DTL_CD = A.PRD_REG_DIS_TP_CD AND COM_CLSF_CD = 'PRD_REG_DIS_TP_CD' AND LANG_CD = 'KO')
				 AS PRD_REG_DIS_TP_NM
			, A.REG_DIS_RSN
			, A.CPRTCP_ID
			, B.CPRTCP_KOR_NM
			, A.DEALR_ID
			, C.OPRTR_NM AS DEALR_NM
			, A.DISP_STATS_CD
			, A.CONSN_RSN
			, A.PRD_USE_YN
			, A.ETC_COL
			, TO_CHAR(A.PROC_DTM,'YYYY-MM-DD HH24:MI:SS') AS PROC_DTM
			, A.REGPSN_ID
			, TO_CHAR(A.REG_DTM,'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
			, A.UPDPSN_ID
			, TO_CHAR(A.UPD_DTM,'YYYY-MM-DD HH24:MI:SS') AS UPD_DTM
			, D.DOC_REG_SEQ
			, D.ATFL_NM
			, D.ATFL_STOR_PATH
			, D.ORI_ATFL_NM
			, '(' || A.NEW_PRD_REQ_GRP_NO || ')' || B.CPRTCP_KOR_NM || '_' || D.ATFL_NM AS EXCEL_DOC_REG_NM
			, E.PURG_CHRPSN_ID
			, E.OPRTR_NM AS PURG_CHRPSN_NM
			, E.EMAIL_ADDR
			FROM SSP_APP.TB_RD_CPRTCP_PKG_LINE_PRPS_MST A
			LEFT JOIN SSP_APP.TB_CP_CPRTCP_BASIS B on A.CO_CD = B.CO_CD AND A.CPRTCP_ID = B.CPRTCP_ID
			LEFT JOIN SSP_APP.TB_CO_MBR_OPRTR_INFO C on A.CO_CD = C.CO_CD AND A.DEALR_ID = C.OPRTR_ID
			LEFT JOIN SSP_APP.TB_CO_ATFL_DTLS D on A.EXCEL_DOC_REG_ID = D.DOC_REG_ID
			LEFT JOIN (SELECT NEW_PRD_REQ_GRP_NO, OPRTR_NM,PURG_CHRPSN_ID,EMAIL_ADDR, COUNT(*) as count FROM
				(SELECT
					FF.NEW_PRD_REQ_GRP_NO
					, FN_RD_CHRPSN_ID(EE.CO_CD, EE.MNFR_NO, EE.PRD_CLCD, '30') AS 	PURG_CHRPSN_ID
					, GG.OPRTR_NM
					, GG.EMAIL_ADDR
				FROM SSP_APP.TB_PR_NEW_PRD_CUST_REQ_INFO EE
				,SSP_APP.TB_RD_CPRTCP_PKG_LINE_PRPS_DTL FF
				,SSP_APP.TB_CO_MBR_OPRTR_INFO GG
				
				WHERE EE.CO_CD = FF.CO_CD
				AND EE.CO_CD = GG.CO_CD
				AND EE.NEW_PRD_REQ_NO = FF.NEW_PRD_REQ_NO
				AND GG.OPRTR_ID = FN_RD_CHRPSN_ID(EE.CO_CD, EE.MNFR_NO, EE.PRD_CLCD, '30') 
				
				ORDER BY FF.NEW_PRD_REQ_GRP_NO
				)COUNT_TB
				
				GROUP BY NEW_PRD_REQ_GRP_NO, OPRTR_NM , COUNT_TB.PURG_CHRPSN_ID, EMAIL_ADDR
	
				HAVING COUNT(*) = (
					SELECT MAX(count) FROM 
					(SELECT
						NEW_PRD_REQ_GRP_NO, OPRTR_NM,PURG_CHRPSN_ID,EMAIL_ADDR, COUNT(*) as count FROM
						(SELECT
							FF.NEW_PRD_REQ_GRP_NO
							, FN_RD_CHRPSN_ID(EE.CO_CD, EE.MNFR_NO, EE.PRD_CLCD, '30') AS 	PURG_CHRPSN_ID
							, GG.OPRTR_NM
							FROM SSP_APP.TB_PR_NEW_PRD_CUST_REQ_INFO EE
							,SSP_APP. TB_RD_CPRTCP_PKG_LINE_PRPS_DTL FF
							,SSP_APP. TB_CO_MBR_OPRTR_INFO GG
				
							WHERE EE.CO_CD = FF.CO_CD
							AND EE.CO_CD = GG.CO_CD
							AND EE.NEW_PRD_REQ_NO = FF.NEW_PRD_REQ_NO
							AND GG.OPRTR_ID = FN_RD_CHRPSN_ID(EE.CO_CD, EE.MNFR_NO, EE.PRD_CLCD, '30')
							
							ORDER BY FF.NEW_PRD_REQ_GRP_NO
					)COUNT_TB
					GROUP BY NEW_PRD_REQ_GRP_NO, OPRTR_NM , COUNT_TB.PURG_CHRPSN_ID, EMAIL_ADDR
				) subquery
					WHERE subquery.NEW_PRD_REQ_GRP_NO = COUNT_TB.NEW_PRD_REQ_GRP_NO
				)
			) E on A.NEW_PRD_REQ_GRP_NO = E.NEW_PRD_REQ_GRP_NO
		WHERE 
		0=0
		<if test='NEW_PRD_REQ_NO != "" and NEW_PRD_REQ_NO != null'>
			and A.NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_NO}
		</if>
		
		<if test='CPRTCP_ID != "" and CPRTCP_ID != null'>
			and A.CPRTCP_ID = #{CPRTCP_ID}
		</if>
		<if test='PURG_CHRPSN_ID != "" and PURG_CHRPSN_ID != null'>
			and E.PURG_CHRPSN_ID	= #{PURG_CHRPSN_ID}
		</if>
		<if
			test='(DATE_FR_DT != null and DATE_FR_DT != "") and (DATE_TO_DT != null and DATE_TO_DT != "")'>
			<if test="REQ_DT_FNL_PROC_DT_SPR == 'REG_DTM'">
				<![CDATA[
					AND TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') BETWEEN TO_CHAR(TO_DATE(#{DATE_FR_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 00:00:00'
                	AND TO_CHAR(TO_DATE(#{DATE_TO_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 23:59:59'
  				]]>
			</if>
			<if test="REQ_DT_FNL_PROC_DT_SPR == 'PROC_DTM'">
   				<![CDATA[
					AND TO_CHAR(A.PROC_DTM, 'YYYY-MM-DD HH24:MI:SS') BETWEEN TO_CHAR(TO_DATE(#{DATE_FR_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 00:00:00'
                    AND TO_CHAR(TO_DATE(#{DATE_TO_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 23:59:59'
  				]]>
			</if>
		</if>
		<if
			test="NEW_PRD_REQ_STATS_CD_LIST != null and NEW_PRD_REQ_STATS_CD_LIST.size() != 0">
			AND A.NEW_PRD_REQ_STATS_CD IN
			<foreach collection="NEW_PRD_REQ_STATS_CD_LIST"
				item="NEW_PRD_REQ_STATS_CD" index="index" separator="," open="("
				close=")">
				#{NEW_PRD_REQ_STATS_CD}
			</foreach>
		</if>
		
		ORDER BY A.REG_DTM desc, A.NEW_PRD_REQ_GRP_NO
	</select>

	<select id="selectNewPrdMltReqLstCount" parameterType="HashMap" resultType="Integer">
		/* NewPrdMltReqLst.selectNewPrdMltReqLstCount 신규상품일괄요청처리 카운트 조회 */
		select count(1)
		from TB_RD_CPRTCP_PKG_LINE_PRPS_MST A
		where 0=0
		<if test='CPRTCP_ID != "" and CPRTCP_ID != null'>
			and A.CPRTCP_ID = #{CPRTCP_ID}
		</if>
		<if test='PURG_CHRPSN_ID != "" and PURG_CHRPSN_ID != null'>
			and A.DEALR_ID = #{PURG_CHRPSN_ID}
		</if>
		<if
			test='(DATE_FR_DT != null and DATE_FR_DT != "") and (DATE_TO_DT != null and DATE_TO_DT != "")'>
			<if test="REQ_DT_FNL_PROC_DT_SPR == 'REG_DTM'">
				<![CDATA[
					AND TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') BETWEEN TO_CHAR(TO_DATE(#{DATE_FR_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 00:00:00'
                	AND TO_CHAR(TO_DATE(#{DATE_TO_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 23:59:59'
  				]]>
			</if>
			<if test="REQ_DT_FNL_PROC_DT_SPR == 'PROC_DTM'">
   				<![CDATA[
					AND TO_CHAR(A.PROC_DTM, 'YYYY-MM-DD HH24:MI:SS') BETWEEN TO_CHAR(TO_DATE(#{DATE_FR_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 00:00:00'
                    AND TO_CHAR(TO_DATE(#{DATE_TO_DT},'YYYYMMDD'),'YYYY-MM-DD') || ' 23:59:59'
  				]]>
			</if>
		</if>
		<if
			test="NEW_PRD_REQ_STATS_CD_LIST != null and NEW_PRD_REQ_STATS_CD_LIST.size() != 0">
			AND A.NEW_PRD_REQ_STATS_CD IN
			<foreach collection="NEW_PRD_REQ_STATS_CD_LIST"
				item="NEW_PRD_REQ_STATS_CD" index="index" separator="," open="("
				close=")">
				#{NEW_PRD_REQ_STATS_CD}
			</foreach>
		</if>
	</select>

	<select id="selectAgrCompDispStt" parameterType="HashMap" resultType="HashMap">
		/* NewPrdMltReqLst.selectAgrCompDispStt 합의완료 진행상태 조회 */
		
		SELECT CASE WHEN B.PRD_ID  LIKE '%RR%' THEN B.PRD_ID ELSE TO_CHAR(TO_NUMBER(B.PRD_ID)) END AS PRD_ID
		     , C.PRD_NM
		     , FN_COM_DTL_CDNM('KO','USE_YN', C.PRD_USE_YN) PRD_USE_NM
		     , FN_COM_DTL_CDNM('KO', 'DISP_STATS_CD', D.DISP_STATS_CD) DISP_STATS_NM
		FROM   TB_RD_CPRTCP_PKG_LINE_PRPS_MST A
		     ,TB_RD_CPRTCP_PKG_LINE_PRPS_DTL B
		     ,TB_PR_PRD_INFO C
		     ,TB_DP_PRD_DISP_STATS_INFO D
		WHERE  A.CO_CD              = B.CO_CD
		AND    A.CO_CD              = C.CO_CD (+)
		AND    A.CO_CD              = D.CO_CD (+)
		AND    A.NEW_PRD_REQ_GRP_NO = B.NEW_PRD_REQ_GRP_NO
		AND    B.PRD_ID             = C.PRD_ID
		AND    B.PRD_ID             = D.PRD_ID
		AND    B.NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_GRP_NO}
		ORDER BY B.PRD_ID
		
		
	</select>

	<select id="selectNewPrdReqLst" parameterType="String"
		resultType="HashMap">
		/* NewPrdMltReqLst.selectNewPrdReqLst 디테일 상품목록 조회 */
		select
		A.CO_CD
		, A.NEW_PRD_REQ_NO
		, A.PRD_ID
		, A.PRD_ID AS RND_REQ_PRD_ID
		, B.NEW_PRD_REQ_STATS_CD
		, B.EXCEL_DOC_REG_ID AS DOC_REG_ID
		, B.EXCEL_DOC_REG_ID
		from TB_RD_CPRTCP_PKG_LINE_PRPS_DTL A
		left join TB_RD_CPRTCP_PKG_LINE_PRPS_MST B on B.NEW_PRD_REQ_GRP_NO=A.NEW_PRD_REQ_GRP_NO
		where A.NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_GRP_NO}
	</select>

	<update id="updateAgrProcRsn" parameterType="HashMap">
		/* NewPrdMltReqLst.updateAgrProcRsn 합의처리 사유 및 상태 저장 */
		update
		TB_RD_CPRTCP_PKG_LINE_PRPS_MST set
		CONSN_RSN = #{CONSN_RSN}
		, UPDPSN_ID = #{UPDPSN_ID}
		, DEALR_ID = #{UPDPSN_ID}
		, NEW_PRD_REQ_STATS_CD = '52'
		, UPD_DTM = SYSDATE
		, PROC_DTM = SYSDATE
		where NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_GRP_NO}
	</update>

	<update id="updateNewPrdMltReqRjct" parameterType="HashMap">
		/* NewPrdMltReqLst.updateNewPrdMltReqRjct 반려처리 사유 및 상태 저장 */
		update
		TB_RD_CPRTCP_PKG_LINE_PRPS_MST set
		PRD_REG_DIS_TP_CD = #{PRD_REG_DIS_TP_CD}
		, REG_DIS_RSN = #{REG_DIS_RSN}
		, NEW_PRD_REQ_STATS_CD = '42'
		, UPDPSN_ID = #{UPDPSN_ID}
		, DEALR_ID = #{UPDPSN_ID}
		, UPD_DTM = SYSDATE
		, PROC_DTM = SYSDATE
		where NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_GRP_NO}
	</update>

	<select id="selectNewPrdReqInfo" parameterType="String" resultType="HashMap">
		/* NewPrdMltReqLst.selectNewPrdReqInfo 상품정보 조회 */
		select
		A.CO_CD
		, A.NEW_PRD_REQ_GRP_NO
		, A.NEW_PRD_REQ_GRP_NO AS NEW_PRD_REQ_NO
		, A.CONT_NO
		, A.CONT_CHG_DGRCNT
		, A.REQ_SBJ_CD
		, A.NEW_PRD_REQ_STATS_CD
		, A.CPRTCP_ID
		, B.ATFL_NM
		, A.EXCEL_DOC_REG_ID
		, TO_CHAR(A.REG_DTM,'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
		, (select OPRTR_NM from TB_CO_MBR_OPRTR_INFO where OPRTR_ID=#{DEALR_ID}) AS OPRTR_NM
		, (select EMAIL_ADDR from TB_CO_MBR_OPRTR_INFO where OPRTR_ID=#{DEALR_ID}) AS EMAIL_ADDR
		, C.CPRTCP_KOR_NM
		from TB_RD_CPRTCP_PKG_LINE_PRPS_MST A
		LEFT JOIN TB_CO_ATFL_DTLS B on A.EXCEL_DOC_REG_ID = B.DOC_REG_ID
		LEFT JOIN SSP_APP.TB_CP_CPRTCP_BASIS C on A.CO_CD = C.CO_CD AND A.CPRTCP_ID = C.CPRTCP_ID
		where NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_GRP_NO}
	</select>

	<update id="updatePrdId" parameterType="HashMap">
		/* NewPrdMltReqLst.updatePrdId 디테일 PRD_ID 최신화 */
		update
			TB_RD_CPRTCP_PKG_LINE_PRPS_DTL set
				PRD_ID = #{RND_REQ_PRD_ID}
				, UPDPSN_ID = #{UPDPSN_ID}
				, UPD_DTM = SYSDATE
		where NEW_PRD_REQ_NO = #{NEW_PRD_REQ_NO}
	</update>

	<select id="selectCustMailRcvAgreYnMulti"	parameterType="HashMap" resultType="String">
		/* NewPrdReqLst.selectCustMailRcvAgreYnMulti | 고객의 업무용메일수신동의여부 검증 */
		SELECT B.MAIL_RCV_AGRE_YN
			FROM TB_PR_NEW_PRD_CUST_REQ_INFO A
		INNER JOIN TB_CC_MBR_BASIS B ON B.CO_CD = A.CO_CD AND B.MBR_ID = A.REGPSN_ID
		WHERE
		A.CO_CD = #{CO_CD}
		AND A.NEW_PRD_REQ_NO = #{NEW_PRD_REQ_NO}
	</select>
	
	
	<update id="updateNewPrdDisp"  parameterType="String">
		
		/* NewPrdMltReqLst.updateNewPrdDisp 합의처리한 상품 진열상태 미진열 처리 작업 */
		UPDATE TB_DP_PRD_DISP_STATS_INFO SET                                              /* 상품진열상태정보 TABLE */
		       DISP_STATS_CD                 = '20'                                       /* 진열상태코드 */
		     , DISP_STATS_CHGRSN             = ''  /* 진열상태변경사유 */     
		     , RND_USCUST_DISP_STATS_CHGRSN  = ''  /* RND고객용진열상태변경사유 */        
		     , UPD_DTM                       = SYSDATE                                    /* 수정일시 */
		 WHERE PRD_ID IN (SELECT AA.PRD_ID                                                /* 상품ID */
		                    FROM TB_RD_CPRTCP_PKG_LINE_PRPS_DTL AA
		                   WHERE AA.NEW_PRD_REQ_GRP_NO = #{NEW_PRD_REQ_GRP_NO})           
	</update>
	
	<select id="selectCprtcpMailRcvAgreYn"	parameterType="HashMap" resultType="String">
		/* NewPrdReqLst.selectCustMailRcvAgreYnMulti | 고객의 업무용메일수신동의여부 검증 */
		SELECT 
			B.CHRPSN_EMAIL_RCV_YN
		FROM TB_RD_CPRTCP_PKG_LINE_PRPS_DTL A
		INNER JOIN TB_CP_CPRTCP_BASIS B ON B.CO_CD = A.CO_CD AND B.CPRTCP_ID = A.REGPSN_ID
		WHERE
		A.CO_CD = #{CO_CD}
		AND A.NEW_PRD_REQ_NO = #{NEW_PRD_REQ_NO}
	</select>
	
	<select id="selectChrpsnInfo" parameterType="HashMap" resultType="HashMap">
		select
			B.CHRPSN_NM
			,B.CHRPSN_EMAIL_ADDR
		FROM TB_RD_CPRTCP_PKG_LINE_PRPS_DTL A
		INNER JOIN TB_CP_CPRTCP_BASIS B ON B.CO_CD = A.CO_CD AND B.CPRTCP_ID = A.REGPSN_ID
		WHERE
		A.CO_CD = #{CO_CD}
		AND A.NEW_PRD_REQ_NO = #{NEW_PRD_REQ_NO}
	</select>
</mapper>