<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PcPubPrdProcStb">
   <!--
    ******************************************************************************
    * SELECT : 공용상품처리대기
    * 작성자 : 
    * 작성 일자 : 2022.02.15
    ******************************************************************************
    -->
	    
    <sql id="PcPubPrdProcStbJoinWhere">
    	<if test=" eprdId > 0 ">
            JOIN
            TB_OD_ODR_INQ_TGT_DTLS   T4
            ON  T4.SES_ID = #{sesId} 
            AND T4.INQ_COND_DTLS = #{inqCondDtls}
            AND T4.COL_ITM = 'ePRD_ID'
            AND LPAD(T4.COND_DATA_VAL, 18, '0') = A.PRD_ID
	   </if>
    	<if test=" ebzplcId > 0 ">
            JOIN
            TB_OD_ODR_INQ_TGT_DTLS   T5
            ON  T5.SES_ID = #{sesId} 
            AND T5.INQ_COND_DTLS = #{inqCondDtls}
            AND T5.COL_ITM = 'eBZPLC_ID'
            AND T5.COND_DATA_VAL = I.BZPLC_ID
	   </if>
    	<if test=" eoprUnitId > 0 ">
            JOIN
            TB_OD_ODR_INQ_TGT_DTLS   T6
            ON  T6.SES_ID = #{sesId} 
            AND T6.INQ_COND_DTLS = #{inqCondDtls}
            AND T6.COL_ITM = 'eOPR_UNIT_ID'
            AND T6.COND_DATA_VAL = K.OPR_UNIT_ID
	   </if>
    	<if test=" ereprPrdGrpId > 0 ">
            JOIN
            TB_OD_ODR_INQ_TGT_DTLS   T7
            ON  T7.SES_ID = #{sesId} 
            AND T7.INQ_COND_DTLS = #{inqCondDtls}
            AND T7.COL_ITM = 'eREPR_PRD_GRP_ID'
            AND LPAD(T7.COND_DATA_VAL, 10, '0') = N.REPR_PRD_GRP_ID
	   </if>
    </sql>
    
    <sql id="PcPubPrdProcStbWhere">
    	<if test="pubOnlySprCd != null and pubOnlySprCd!= ''.toString()">
    		AND B.PUB_ONLY_SPR_CD = #{pubOnlySprCd}
		</if>
    	<if test="procStatsCd != null and procStatsCd!= ''.toString()">
    		AND Z.PRC_PROC_STATS_CD = #{procStatsCd}
		</if>
		<if test="prdClcd != null and prdClcd!= ''.toString()">
		    AND	A.PRD_CLCD = #{prdClcd}
		</if>
		<if test="reprPrdSprCd != null and reprPrdSprCd!= ''.toString()">
		    <choose>
				<when test='"3" eq reprPrdSprCd'>
					AND (N.REPR_PRD_SPR_YN = 'N')
				</when>
				<when test='"NONE" eq reprPrdSprCd'>
					AND (N.REPR_PRD_SPR_YN IS NULL)
				</when>
				<otherwise>
					AND N.REPR_PRD_SPR_RSN_CD = #{reprPrdSprCd}
				</otherwise>
			</choose>
		</if>
		<if test="prcAplySprCd != null and prcAplySprCd!= ''.toString()">
		    <choose>
		    	<when test='"0" eq prcAplySprCd'>
			AND	A.PRC_APLY_SPR_CD IS NULL
				</when>
				<otherwise>
			AND	A.PRC_APLY_SPR_CD = #{prcAplySprCd}
				</otherwise>
		    </choose>
		    
		</if>
		<if test="newPrdReqNo != null and newPrdReqNo!= ''.toString()">
		    AND Z.NEW_PRD_REQ_NO IN
		    <foreach collection="newPrdReqList" item="item" index="index"  open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="dateCd != null and dateCd!= ''.toString()">
			<if test="strDtm != null and strDtm!= ''.toString() and endDtm != null and endDtm!= ''.toString()">
		    <choose>
				<when test='"10" eq dateCd'>
					<![CDATA[
				    AND Z.REG_DTM >= TO_DATE(#{strDtm}||'000000','YYYYMMDDHH24MISS')
				    AND Z.REG_DTM < TO_DATE(#{endDtm}||'235959','YYYYMMDDHH24MISS')
				    ]]>
				</when>
				<when test='"20" eq dateCd'>
					<![CDATA[
				    AND C.REG_DTM >= TO_DATE(#{strDtm}||'000000','YYYYMMDDHH24MISS')
				    AND C.REG_DTM < TO_DATE(#{endDtm}||'235959','YYYYMMDDHH24MISS')
				    ]]>
				</when>
			</choose>
			</if>
		</if>
		<if test="teamId != null and teamId!= ''.toString()">
    		AND O.ORG_CD = #{teamId}
		</if>
		<if test="chrpsnCd != null and chrpsnCd!= ''.toString()">
		    <if test="chrpsnId != null and chrpsnId!= ''.toString()">
		    	<choose>
					<when test='"10" eq chrpsnCd'>
						AND P.OPRTR_ID = #{chrpsnId}
					</when>
					<when test='"20" eq chrpsnCd'>
						AND B.PURG_CHRPSN_ID = #{chrpsnId}
					</when>
					<when test='"30" eq chrpsnCd'>
						AND O.OPRTR_ID =  #{chrpsnId}
					</when>
				</choose>
			</if>
		</if>
	</sql>

	<!-- 처리대기 목록 -->
    <select id="selectPcPubPrdProcStbList" parameterType="HashMap" resultType="HashMap">
        /* PcPubPrdProcStb.selectPcPubPrdProcStbList */
        SELECT 
        	*
        FROM (
			SELECT 
				0 AS CHK,
				A.CO_CD,
				A.PRD_ID,
				TO_NUMBER(A.PRD_ID) AS PRD_ID_NUM,
				Z.NEW_PRD_REQ_NO AS NEW_PRD_REQ_NO, --신규상품요청번호
				FN_COM_DTL_CDNM('KO','PRC_PROC_STATS_CD',Z.PRC_PROC_STATS_CD) AS PRC_STATE_NM,
				Z.PRC_PROC_STATS_CD AS PRC_STATE_CD,
				REPR_PRD_GRP_ID AS REPR_PRD_GRP_ID,
				TO_NUMBER(REPR_PRD_GRP_ID) AS REPR_PRD_GRP_ID_VIEW, --0제거 대표상품그룹ID
				A.PRD_CLCD,
				B.PUB_ONLY_SPR_CD,
				SEL_MTHD_CD AS SEL_MTHD_CD,
				DECODE(N.REPR_PRD_SPR_YN, 'Y', N.REPR_PRD_SPR_RSN_CD, '3') AS REPR_PRD_SPR_CD, --대표상품구분코드 피통합,가격,품질
				CASE WHEN B.PUB_ONLY_SPR_CD = 'P' THEN NVL(FN_COM_DTL_CDNM('KO','REPR_PRD_SPR_CD',DECODE(N.REPR_PRD_SPR_YN, 'Y', N.REPR_PRD_SPR_RSN_CD, 'N','3')),'미사용') ELSE '' END  AS REPR_PRD_SPR_NM,
				FN_COM_DTL_CDNM('KO', 'MRO_PRD_STATS_CD', B.MRO_PRD_STATS_CD) MRO_PRD_STATS_CD,  -- S-MRO상품상태
				FN_COM_DTL_CDNM('KO','USE_YN', A.PRD_USE_YN) PRD_STATS_CD, -- SSP상품상태
				C.DISP_STATS_CD,
				FN_COM_DTL_CDNM('KO','DISP_STATS_CD',C.DISP_STATS_CD) AS DISP_STATS_NM,
				A.PRD_NM,
				B.MNFR_NO,
				B.SELL_UNIT_CD,
				B.ORGPLC_CTRY_CD,
				I.BZPLC_ID AS BZPLC_ID,
				I.BZPLC_NM AS BZPLC_NM,
				K.OPR_UNIT_NM AS OPR_UNIT_NM,
				K.OPR_UNIT_ID AS OPR_UNIT_ID,
				H.MBR_ID AS MEM_ID,
				H.MBR_NM AS MEM_NM,
				B.DLV_LT AS DLV_LT, 
				P.OPRTR_ID AS OPRTR_ID, -- 운영담당자
				P.OPRTR_NM AS OPRTR_NM, 
				B.PURG_CHRPSN_ID AS OPRTR_ID1,	--구매담당자
				(SELECT OPRTR_NM FROM TB_CO_MBR_OPRTR_INFO WHERE OPRTR_ID = B.PURG_CHRPSN_ID) AS OPRTR_NM1,	--구매담당자
				O.OPRTR_ID AS OPRTR_ID2,	--MD담당자
				O.OPRTR_NM AS OPRTR_NM2,	--MD담당자
				Z.REG_DTM AS PRD_REG_DTM,
				C.REG_DTM AS PRC_REG_DTM,
				A.PRC_APLY_SPR_CD,
				NVL2(M.INVN_STATS_CD,'재고','미재고') AS INVN_STATS_NM,
				FN_PR_ATTR_VAL_LIST(#{coCd},A.PRD_ID) AS ATTR_VAL,
				FN_COM_DTL_CDNM('KO','PUB_ONLY_SPR_CD',B.PUB_ONLY_SPR_CD) AS PUB_ONLY_SPR_NM,
				CASE WHEN B.PUB_ONLY_SPR_CD = 'P' THEN FN_COM_DTL_CDNM('KO','SEL_MTHD_CD',SEL_MTHD_CD) ELSE '' END  AS SEL_MTHD_NM,
				FN_COM_DTL_CDNM('KO','PRC_APLY_SPR_CD',A.PRC_APLY_SPR_CD) AS PRC_APLY_SPR_NM,
				FN_PR_FULL_CLSF_NM(#{coCd},A.PRD_CLCD) AS PRD_CLCD_NM,
				(SELECT Z.MRO_MNFR_NM FROM TB_PR_MNFR_INFO Z WHERE Z.CO_CD = A.CO_CD AND Z.MNFR_NO = B.MNFR_NO) MNFR_NM,
				CASE WHEN (SELECT count(*) FROM TB_SA_EXHBN_CATG_PRD_DTL Z INNER JOIN TB_SA_EXHBN_INFO X ON Z.CO_CD = X.CO_CD	AND Z.EXHBN_SEQ = X.EXHBN_SEQ AND X.USE_YN = 'Y' WHERE Z.PRD_ID = A.PRD_ID) > 0 THEN '대상' ELSE '미대상' END  AS EXHBN_CNT,
				L.CTRY_NM AS ORGPLC_CTRY_NM,
				Z.PRC_REG_DIS_TP_CD, 
				FN_COM_DTL_CDNM('KO','PRC_REG_DIS_TP_CD',Z.PRC_REG_DIS_TP_CD) AS PRC_REG_DIS_TP_NM,
				Z.REG_DIS_RSN,
				SSP_APP.FN_PR_GET_SSP_PRD_NM(A.CO_CD, A.PRD_ID) SSP_PRD_NM
			FROM TB_PC_NEW_PRD_REQ_PRC_INFO Z
			INNER JOIN TB_PR_PRD_INFO A --상품마스터
				ON Z.CO_CD = A.CO_CD
				AND Z.PRD_ID = A.PRD_ID
				AND A.MALL_SPR_CD = '10'
			INNER JOIN TB_PR_MRO_PRD_INFO B --MRO상품 마스터
				ON A.CO_CD = B.CO_CD
				AND A.PRD_ID = B.PRD_ID
			LEFT OUTER JOIN TB_PR_PRD_CLSF_INFO D -- 분류마스터
				ON A.CO_CD = D.CO_CD
				AND A.PRD_CLCD = D.PRD_CLCD
			LEFT OUTER JOIN TB_PR_NEW_PRD_CUST_REQ_INFO G -- 신규상품
				ON Z.CO_CD = G.CO_CD
				AND Z.NEW_PRD_REQ_NO = G.NEW_PRD_REQ_NO
			LEFT OUTER JOIN TB_CC_MBR_BASIS H --회원
				ON G.CO_CD = H.CO_CD
				AND G.REGPSN_ID = H.MBR_ID
			LEFT OUTER JOIN TB_CC_BZPLC_BASIS I --사업장
				ON H.CO_CD = I.CO_CD
				AND H.BZPLC_ID = I.BZPLC_ID
			LEFT OUTER JOIN TB_CC_DEPT_BASIS J --부서
				ON H.CO_CD = J.CO_CD
				AND H.DEPT_ID = J.DEPT_ID
			LEFT OUTER JOIN TB_CC_OPR_UNIT_BASIS K --운영단위
				ON J.CO_CD = K.CO_CD
				AND J.OPR_UNIT_ID = K.OPR_UNIT_ID
			LEFT OUTER JOIN TB_CO_MBR_OPRTR_INFO P
				ON K.CO_CD = P.CO_CD
				AND K.SALS_CHRPSN_ID = P.OPRTR_ID
			LEFT OUTER JOIN TB_DP_PRD_DISP_STATS_INFO C -- 진열정보
				ON A.CO_CD = C.CO_CD
				AND A.PRD_ID = C.PRD_ID
				AND ((B.PUB_ONLY_SPR_CD = 'P' AND C.BZPLC_ID = '*' AND C.OPR_UNIT_ID = '*')
					OR (B.PUB_ONLY_SPR_CD = 'E' AND C.BZPLC_ID = I.BZPLC_ID AND C.OPR_UNIT_ID = K.OPR_UNIT_ID))
			LEFT JOIN TB_CO_CTRY_INFO L -- 국가
				ON A.CO_CD = L.CO_CD
				AND B.ORGPLC_CTRY_CD = L.CTRY_SPR_CD
			LEFT OUTER JOIN VW_IV_PRD_INVN_DTLS M
			ON M.CO_CD = A.CO_CD
			AND M.PRD_ID = A.PRD_ID
			LEFT OUTER JOIN TB_PR_REPR_PRD_MNG_DTL N  --대표상품
                ON N.CO_CD = A.CO_CD AND N.PRD_ID = A.PRD_ID AND N.SSP_PRD_YN = 'Y'
            LEFT OUTER JOIN (
               SELECT A.CO_CD, A.PRD_CLCD, OPRTR_ID, OPRTR_NM, PRD_CLSF_CHRPSN_TP_CD ,B.ORG_CD
               FROM TB_PR_PRD_CLSF_CHRPSN_INFO A
               INNER JOIN TB_CO_MBR_OPRTR_INFO B
               ON A.CO_CD = B.CO_CD
               AND A.PRD_CLSF_CHRPSN_ID = B.OPRTR_ID
               WHERE A.PRD_CLSF_CHRPSN_SPR_CD = '10'
               AND A.PRD_CLSF_CHRPSN_TP_CD = '20'
            )O
				ON A.CO_CD = O.CO_CD
				AND A.PRD_CLCD = O.PRD_CLCD
			<include refid="PcPubPrdProcStbJoinWhere" />
			<where>
			 	<include refid="PcPubPrdProcStbWhere" />
			</where>
		)A
		<choose>
			<when test="sortColumn != null and !sortColumn.equals('') and  sortType != null and !sortType.equals('')">
				ORDER BY A.${sortColumn} ${sortType}
			</when>
			<otherwise>ORDER BY A.NEW_PRD_REQ_NO DESC</otherwise>
		</choose>
		OFFSET #{startNum} ROWS FETCH FIRST #{rowCount} ROWS ONLY 
    </select>
    
    <select id="selectPcPubPrdProcStbCount" parameterType="hashMap" resultType="integer">
    	/* PcPubPrdProcStb.selectPcPubPrdProcStbCount */
		SELECT
			COUNT(0)
		FROM TB_PC_NEW_PRD_REQ_PRC_INFO Z
			INNER JOIN TB_PR_PRD_INFO A --상품마스터
				ON Z.CO_CD = A.CO_CD
				AND Z.PRD_ID = A.PRD_ID
				AND A.MALL_SPR_CD = '10'
			INNER JOIN TB_PR_MRO_PRD_INFO B --MRO상품 마스터
				ON A.CO_CD = B.CO_CD
				AND A.PRD_ID = B.PRD_ID
			LEFT OUTER JOIN TB_PR_PRD_CLSF_INFO D -- 분류마스터
				ON A.CO_CD = D.CO_CD
				AND A.PRD_CLCD = D.PRD_CLCD
			LEFT OUTER JOIN TB_PR_NEW_PRD_CUST_REQ_INFO G -- 신규상품
				ON Z.CO_CD = G.CO_CD
				AND Z.NEW_PRD_REQ_NO = G.NEW_PRD_REQ_NO
			LEFT OUTER JOIN TB_CC_MBR_BASIS H --회원
				ON G.CO_CD = H.CO_CD
				AND G.REGPSN_ID = H.MBR_ID
			LEFT OUTER JOIN TB_CC_BZPLC_BASIS I --사업장
				ON H.CO_CD = I.CO_CD
				AND H.BZPLC_ID = I.BZPLC_ID
			LEFT OUTER JOIN TB_CC_DEPT_BASIS J --부서
				ON H.CO_CD = J.CO_CD
				AND H.DEPT_ID = J.DEPT_ID
			LEFT OUTER JOIN TB_CC_OPR_UNIT_BASIS K --운영단위
				ON J.CO_CD = K.CO_CD
				AND J.OPR_UNIT_ID = K.OPR_UNIT_ID
			LEFT OUTER JOIN TB_CO_MBR_OPRTR_INFO P
				ON K.CO_CD = P.CO_CD
				AND K.SALS_CHRPSN_ID = P.OPRTR_ID
			LEFT OUTER JOIN TB_DP_PRD_DISP_STATS_INFO C -- 진열정보
				ON A.CO_CD = C.CO_CD
				AND A.PRD_ID = C.PRD_ID
				AND ((B.PUB_ONLY_SPR_CD = 'P' AND C.BZPLC_ID = '*' AND C.OPR_UNIT_ID = '*')
					OR (B.PUB_ONLY_SPR_CD = 'E' AND C.BZPLC_ID = I.BZPLC_ID AND C.OPR_UNIT_ID = K.OPR_UNIT_ID))
			LEFT JOIN TB_CO_CTRY_INFO L -- 국가
				ON A.CO_CD = L.CO_CD
				AND B.ORGPLC_CTRY_CD = L.CTRY_SPR_CD
			LEFT OUTER JOIN VW_IV_PRD_INVN_DTLS M
			ON M.CO_CD = A.CO_CD
			AND M.PRD_ID = A.PRD_ID
			LEFT OUTER JOIN TB_PR_REPR_PRD_MNG_DTL N  --대표상품
                ON N.CO_CD = A.CO_CD AND N.PRD_ID = A.PRD_ID AND N.SSP_PRD_YN = 'Y'
            LEFT OUTER JOIN (
               SELECT A.CO_CD, A.PRD_CLCD, OPRTR_ID, OPRTR_NM, PRD_CLSF_CHRPSN_TP_CD ,B.ORG_CD
               FROM TB_PR_PRD_CLSF_CHRPSN_INFO A
               INNER JOIN TB_CO_MBR_OPRTR_INFO B
               ON A.CO_CD = B.CO_CD
               AND A.PRD_CLSF_CHRPSN_ID = B.OPRTR_ID
               WHERE A.PRD_CLSF_CHRPSN_SPR_CD = '10'
               AND A.PRD_CLSF_CHRPSN_TP_CD = '20'
            )O
				ON A.CO_CD = O.CO_CD
				AND A.PRD_CLCD = O.PRD_CLCD
			<include refid="PcPubPrdProcStbJoinWhere" />
		 <where>
		 	<include refid="PcPubPrdProcStbWhere" />
		</where>
    </select>

    
</mapper>