<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PrProperty">

<!--
    ******************************************************************************
    * SELECT : SSP속성 목록 조회
    * 작성자 : 이원준
    * 작성 일자 : 2022.02.17
    ******************************************************************************
    -->
    <select id="selectPropertyList" parameterType="HashMap" resultType="HashMap">
        /* Property.selectPropertyList */
        SELECT A.CO_CD
             , A.PRD_ATTR_CD
             , A.MALL_SPR_CD
             , A.PRNM
             , A.USE_YN
             , TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
             , TO_CHAR(A.UPD_DTM, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DTM
             , A.REGPSN_ID
             , C.OPRTR_NM AS REGPSN_NM
             , A.UPDPSN_ID
             , D.OPRTR_NM AS UPDPSN_NM
             , NVL(COUNT(B.PRD_ATTR_CD),0) AS ATTR_CNT
             , NVL(E.PRD_CLCD_CNT,0)       AS PRD_CLCD_CNT
          FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
             , SSP_APP.TB_PR_PRD_INFO_ATTR_MAPP B
             , TB_CO_MBR_OPRTR_INFO C
             , TB_CO_MBR_OPRTR_INFO D
             , (SELECT COUNT(T1.PRD_CLCD) AS PRD_CLCD_CNT, T1.PRD_ATTR_CD, T1.CO_CD
                  FROM SSP_APP.TB_PR_PRD_CLSF_ATTR_MAPP T1
                     , SSP_APP.TB_PR_PRD_ATTR_INFO T2
                 WHERE T1.CO_CD = T2.CO_CD
                   AND T1.PRD_ATTR_CD = T2.PRD_ATTR_CD
                   AND T1.CO_CD = #{CO_CD}
                   AND T2.MALL_SPR_CD = #{MALL_SPR_CD}
                 GROUP BY T1.PRD_ATTR_CD, T1.CO_CD
                 ) E
        WHERE 1 = 1
          AND A.CO_CD       = B.CO_CD(+)
          AND A.CO_CD       = E.CO_CD(+)
          AND A.PRD_ATTR_CD = B.PRD_ATTR_CD(+)
          AND A.PRD_ATTR_CD = E.PRD_ATTR_CD(+)
          AND A.REGPSN_ID = C.OPRTR_ID(+)
          AND A.UPDPSN_ID = D.OPRTR_ID(+)   
          AND A.CO_CD       = #{CO_CD}
          AND A.MALL_SPR_CD = #{MALL_SPR_CD}
        <if test="PRNM != null and PRNM != ''">
           AND REGEXP_LIKE(A.PRNM, #{PRNM})
        </if>
        <if test="PRD_ATTR_CD != null and PRD_ATTR_CD != ''">
           AND EXISTS (SELECT 'X' 
                         FROM TB_OD_ODR_INQ_TGT_DTLS T1
                         WHERE T1.SES_ID = #{SES_ID}
                             AND T1.INQ_COND_DTLS = #{INQ_COND_DTLS}
                             AND T1.COL_ITM = 'PRD_ATTR_CD'
                             AND A.PRD_ATTR_CD = T1.COND_DATA_VAL )   
        </if>
        <if test="USE_YN != null and USE_YN != ''">
           AND A.USE_YN = #{USE_YN}
        </if>
        <if test="START_DT != null and START_DT != ''">
           <choose>
              <when test="CAL_GUBUN == '10'">
                  AND TO_CHAR(A.REG_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
              </when>
              <otherwise>
                  AND TO_CHAR(A.UPD_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
              </otherwise>
           </choose>
         </if>
        GROUP BY A.CO_CD
            , A.PRD_ATTR_CD
            , A.MALL_SPR_CD
            , A.PRNM
            , A.USE_YN
            , A.REG_DTM
            , A.UPD_DTM
            , A.REGPSN_ID
            , A.UPDPSN_ID
            , C.OPRTR_NM
            , D.OPRTR_NM
            , E.PRD_CLCD_CNT
         <choose>
            <when test="SORT_COLUMN != null and SORT_COLUMN != ''">
                ORDER BY ${SORT_COLUMN} ${SORT_TYPE}
            </when>
            <otherwise>
                ORDER BY A.PRD_ATTR_CD DESC
            </otherwise>
        </choose>
        OFFSET #{START_NUM} ROWS FETCH FIRST #{ROW_COUNT} ROWS ONLY 
    </select>
    
    <select id="selectPropertyCount" parameterType="HashMap" resultType="integer">
        /* Property.selectPropertyCount */
        SELECT COUNT(0)
          FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
         WHERE 1 = 1
           AND A.CO_CD       = #{CO_CD}
           AND A.MALL_SPR_CD = #{MALL_SPR_CD}
        <if test="PRNM != null and PRNM != ''">
           AND REGEXP_LIKE(A.PRNM, #{PRNM})
        </if>
        <if test="PRD_ATTR_CD != null and PRD_ATTR_CD != ''">
           AND EXISTS (SELECT 'X' 
                         FROM TB_OD_ODR_INQ_TGT_DTLS T1
                         WHERE T1.SES_ID = #{SES_ID}
                             AND T1.INQ_COND_DTLS = #{INQ_COND_DTLS}
                             AND T1.COL_ITM = 'PRD_ATTR_CD'
                             AND A.PRD_ATTR_CD = T1.COND_DATA_VAL )   
        </if>
        <if test="USE_YN != null and USE_YN != ''">
           AND A.USE_YN = #{USE_YN}
        </if>
        <if test="START_DT != null and START_DT != ''">
           <choose>
              <when test="CAL_GUBUN == '10'">
                  AND TO_CHAR(A.REG_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
              </when>
              <otherwise>
                  AND TO_CHAR(A.UPD_DTM,'YYYYMMDD') BETWEEN #{START_DT} AND #{END_DT}
              </otherwise>
           </choose>
        </if>
    </select>
    
     <select id="selectProperty" parameterType="HashMap" resultType="HashMap">
        /* Property.selectProperty */
        SELECT A.CO_CD
             , A.PRD_ATTR_CD
             , A.MALL_SPR_CD
             , A.PRNM
             , A.USE_YN
             , TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
             , TO_CHAR(A.UPD_DTM, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DTM
             , NVL(C.PRD_CLCD_CNT,0)                       AS PRD_CLCD_CNT
        FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
           , (SELECT COUNT(T1.PRD_CLCD) AS PRD_CLCD_CNT, T1.PRD_ATTR_CD, T1.CO_CD
                  FROM SSP_APP.TB_PR_PRD_CLSF_ATTR_MAPP T1
                     , SSP_APP.TB_PR_PRD_ATTR_INFO T2
                 WHERE T1.CO_CD = T2.CO_CD
                   AND T1.PRD_ATTR_CD = T2.PRD_ATTR_CD
                   AND T1.CO_CD = #{CO_CD}
                   AND T2.MALL_SPR_CD = #{MALL_SPR_CD}
                 GROUP BY T1.PRD_ATTR_CD, T1.CO_CD
                 ) C
        WHERE 1 = 1
          AND A.CO_CD = C.CO_CD(+)
          AND A.PRD_ATTR_CD = C.PRD_ATTR_CD(+)
          AND A.CO_CD   = #{CO_CD}
          AND A.PRD_ATTR_CD = #{PRD_ATTR_CD}  
          AND A.MALL_SPR_CD = #{MALL_SPR_CD}  
    </select> 
    
    <insert id="insertProperty" parameterType="HashMap">
        /* Property.insertProperty */
        INSERT INTO SSP_APP.TB_PR_PRD_ATTR_INFO (
               CO_CD
             , PRD_ATTR_CD
             , MALL_SPR_CD
             , PRNM
             , USE_YN
             , REG_DTM
             , REGPSN_ID
        ) VALUES (
              #{CO_CD}
            , (SELECT 'P'|| LPAD(TO_CHAR(NVL(MAX(SUBSTR(PRD_ATTR_CD,2)), 0) + 1), 4, '0') FROM SSP_APP.TB_PR_PRD_ATTR_INFO WHERE MALL_SPR_CD = #{MALL_SPR_CD})
            , #{MALL_SPR_CD}
            , #{PRNM}
            , #{USE_YN}
            , SYSDATE
            , #{USER_ID}
        )    
    </insert> 
    
    <update id="updateProperty" parameterType="HashMap">
        /* Property.updateProperty */
        UPDATE SSP_APP.TB_PR_PRD_ATTR_INFO
           SET PRNM           = #{PRNM}
             , USE_YN         = #{USE_YN}
             , UPD_DTM        = SYSDATE
             , UPDPSN_ID      = #{USER_ID}
         WHERE CO_CD          = #{CO_CD}
           AND PRD_ATTR_CD    = #{PRD_ATTR_CD}    
    </update> 
    
    <select id="selectPropertyPrNm" parameterType="HashMap" resultType="integer">
        /* Property.selectPropertyPrNm */
        SELECT COUNT(0)
          FROM SSP_APP.TB_PR_PRD_ATTR_INFO A
         WHERE 1 = 1
           AND A.CO_CD       = #{CO_CD}
           AND A.MALL_SPR_CD = #{MALL_SPR_CD}
           AND A.PRNM        = #{PRNM}
    </select>    
    
</mapper>