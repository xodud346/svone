<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CoMnuMng">
   <!--
    ******************************************************************************
    * SELECT : 메뉴 조회
    * 작성자 : ksy
    * 작성 일자 : 2022-01-18
    ******************************************************************************
    -->
    <resultMap id="MnuMngListResultMap" type="HashMap">
        <result property="MNU_SEQ"         column="MNU_SEQ" />
        <result property="MNU_NM"          column="MNU_NM" />
        <result property="MNU_LVL"         column="MNU_LVL" />
        <result property="MNU_LVL_SPR_CD"  column="MNU_LVL_SPR_CD" />
        <result property="MNU_TP_CD"       column="MNU_TP_CD" />
        <result property="HRNK_MNU_SEQ"    column="HRNK_MNU_SEQ" />
        <result property="HGST_MNU_SEQ"    column="HGST_MNU_SEQ" />
        <result property="PGM_ID"          column="PGM_ID" />
        <result property="PGM_NM"          column="PGM_NM" />
        <result property="PGM_CALL_PATH"   column="PGM_CALL_PATH" />
        <result property="PGM_TP_CD"       column="PGM_TP_CD" />
        <result property="THME_DOMN_CD"    column="THME_DOMN_CD" />
        <result property="UI_ID"           column="UI_ID" />
        <result property="MDL_NM"          column="MDL_NM" />
        <result property="RMKS_CTS"          column="RMKS_CTS" />
        <result property="SRT_SO"          column="SRT_SO" />
        <result property="USE_YN"          column="USE_YN" />
    </resultMap>
    <select id="selectMnuMngList" parameterType="HashMap" resultMap="MnuMngListResultMap">
    <!-- CoMnuMng.selectMnuMngList  -->
       SELECT DISTINCT
            MNU_SEQ
		     ,MNU_NM
		     ,MNU_LVL
		     ,MNU_LVL_SPR_CD
		     ,MNU_TP_CD
		     ,HRNK_MNU_SEQ
		     ,HGST_MNU_SEQ
		     ,PGM_ID
		     ,PGM_NM
		     ,PGM_CALL_PATH
		     ,PGM_TP_CD
		     ,THME_DOMN_CD
		     ,UI_ID
		     ,MDL_NM
		     ,RMKS_CTS
		     ,SRT_SO
		     ,USE_YN
             ,THME_DOMN_CD || '::' || UI_ID AS PGM_PATH
           FROM (
           SELECT A.MNU_SEQ
                     , A.MNU_NM
                     , A.MNU_LVL
                     , A.MNU_LVL_SPR_CD
                     , A.MNU_TP_CD
                     , A.HRNK_MNU_SEQ
                     , A.HGST_MNU_SEQ
                     , A.PGM_ID
                     , B.PGM_NM
                     , B.PGM_CALL_PATH
                     , B.PGM_TP_CD
                     , B.THME_DOMN_CD
                     , B.UI_ID
                     , B.MDL_NM
                     , A.RMKS_CTS
                     , A.SRT_SO
                     , A.USE_YN
                     , B.THME_DOMN_CD || '::' || B.UI_ID AS PGM_PATH
		  FROM SSP_APP.TB_CO_MNU_INFO A
		     , SSP_APP.TB_CO_SYS_PGM_INFO B
             , SSP_APP.TB_CO_MNU_AUTH_INFO C
		 WHERE A.PGM_ID = B.PGM_ID (+)
           AND A.MNU_SEQ = C.MNU_SEQ
           AND AUTH_ROLE_CD = '11100'
		   AND A.USE_YN = 'Y'
		<if test="oprtrId != 'X0025958'">
		   AND A.MNU_SEQ IN (
		   					<include refid="oprtrAuthMnuList" />
		   					 )
		</if>)
		 ORDER BY SRT_SO
    </select>
    
    <sql id="oprtrAuthMnuList">
    <!-- 권한 조회 -->
	  SELECT DISTINCT A.MNU_SEQ
		FROM (
		      /* 권한그룹 메뉴 조회 */
		      SELECT A.MNU_SEQ
		        FROM SSP_APP.TB_CO_MNU_INFO A
		       INNER JOIN SSP_APP.TB_CO_MNU_AUTH_INFO B
		          ON A.MNU_SEQ = B.MNU_SEQ
		       INNER JOIN SSP_APP.TB_CO_MNU_AUTH_GRP_INFO C
		          ON B.AUTH_ROLE_CD = C.AUTH_ROLE_CD
		       WHERE C.AUTH_GRP_CD IN (SELECT DISTINCT A.AUTH_GRP_ROLE_CD
		                                 FROM (
							              	   /* 로그인한 사람이 속한 부서의 부서별 메뉴권한 조회  */
									           SELECT A.AUTH_GRP_ROLE_CD
									             FROM SSP_APP.TB_CO_OPRTR_ORG_AUTH_GRP_INFO A
									            WHERE A.CO_CD = #{coCd}
									              AND A.ORG_CD = #{orgCd}
									              AND A.AUTH_GRP_ROLE_CLCD = '1'
									            UNION ALL
									            /* 로그인한 사람의 메뉴 권한 */
									            SELECT A.AUTH_GRP_ROLE_CD
									              FROM SSP_APP.TB_CO_OPRTR_AUTH_INFO A
									             WHERE A.CO_CD = #{coCd}
									               AND A.OPRTR_ID = #{oprtrId}
									               AND A.AUTH_GRP_ROLE_CLCD = '1'
									            ) A
									    )
			  GROUP BY A.MNU_SEQ
		      UNION ALL
		      /* 권한ROLE 메뉴 조회 */
		      SELECT A.MNU_SEQ
		        FROM SSP_APP.TB_CO_MNU_INFO A
		       INNER JOIN SSP_APP.TB_CO_MNU_AUTH_INFO B
		          ON A.MNU_SEQ = B.MNU_SEQ
		       WHERE B.AUTH_ROLE_CD IN (SELECT DISTINCT A.AUTH_GRP_ROLE_CD
		                                  FROM (
		              							/* 로그인한 사람이 속한 부서의 부서별 메뉴권한 조회  */
									            SELECT A.AUTH_GRP_ROLE_CD
									              FROM SSP_APP.TB_CO_OPRTR_ORG_AUTH_GRP_INFO A
									             WHERE A.CO_CD = #{coCd}
									               AND A.ORG_CD = #{orgCd}
									               AND A.AUTH_GRP_ROLE_CLCD = '2'
									             UNION ALL
									             /* 로그인한 사람의 메뉴 권한 */
									             SELECT A.AUTH_GRP_ROLE_CD
									               FROM SSP_APP.TB_CO_OPRTR_AUTH_INFO A
									              WHERE A.CO_CD = #{coCd}
									                AND A.OPRTR_ID = #{oprtrId}
									                AND A.AUTH_GRP_ROLE_CLCD = '2'
									             ) A
									    )
		        GROUP  BY A.MNU_SEQ
		        ) A 
    </sql>
    
    
    <!--
    ******************************************************************************
    * SELECT : 메뉴관리 목록 조회
    * 작성자 : ksy
    * 작성 일자 : 2022-01-18
    ******************************************************************************
    -->
    <select id="selectMnuList" parameterType="HashMap" resultType="HashMap">
        SELECT A.MNU_SEQ
		     , A.MNU_NM
		     , A.MNU_LVL
		     , A.MNU_LVL_SPR_CD
		     , A.MNU_TP_CD
		     , A.HRNK_MNU_SEQ
		     , A.HGST_MNU_SEQ
		     , A.PGM_ID
		     , B.PGM_NM
		     , B.PGM_CALL_PATH
		     , B.PGM_TP_CD
		     , B.THME_DOMN_CD
		     , B.UI_ID
		     , B.MDL_NM
		     , A.RMKS_CTS
		     , A.SRT_SO
		     , A.USE_YN
             , B.THME_DOMN_CD || '::' || B.UI_ID AS PGM_PATH
		  FROM SSP_APP.TB_CO_MNU_INFO A
		     , SSP_APP.TB_CO_SYS_PGM_INFO B
		 WHERE A.PGM_ID = B.PGM_ID (+)
		   AND A.USE_YN = 'Y'
		 ORDER BY SRT_SO
    </select>
    
      <select id="selectMenuFileList" parameterType="HashMap" resultType="HashMap">
          /* CoMnuMng.selectMenuFileList */
          SELECT DOC_REG_ID
             , DOC_REG_SEQ
             , ATFL_NM
             , ATFL_LEN
             , TO_CHAR(ROUND(ATFL_LEN/POWER(1024, FLOOR(LOG(1024, ATFL_LEN))), 2)) || DECODE(FLOOR(LOG(1024, ATFL_LEN)) ,0,' B',1,' KB',2,' MB',3,' GB') AS ATFL_LEN_NM
             , ATFL_STOR_PATH
             , ORI_ATFL_NM
             , SAP_DOC_ID
             , ATFL_META_SEQ
          FROM SSP_APP.TB_CO_ATFL_DTLS
         WHERE DOC_REG_ID = #{docRegId}
    </select>

    <!--
    ******************************************************************************
    * INSERT : 메뉴 등록
    * 작성자 : lee
    * 작성 일자 : 2022-01-26
    ******************************************************************************
    -->
    <insert id="insertComMenu" parameterType="HashMap">
        /* CoMnuMng.insertComMenu */
        INSERT INTO SSP_APP.TB_CO_MNU_INFO
        (
           MNU_SEQ
         , MNU_NM
         , MNU_LVL
         , MNU_LVL_SPR_CD
         , MNU_TP_CD
         , HRNK_MNU_SEQ
         , HGST_MNU_SEQ
         , PGM_ID
         , SRT_SO
         , USE_YN
         , RMKS_CTS
         , DOC_REG_ID
         , REG_DTM
         , REGPSN_ID
         , UPD_DTM
         , UPDPSN_ID
        ) VALUES (
           #{mnuSeq}
         , #{mnuNm}
         , #{mnuLvl}
         , #{mnuLvlSprCd}
         , #{mnuTpCd}
         , #{hrnkMnuSeq}
         , #{hgstMnuSeq}
         , #{pgmId}
         , #{srtSo}
         , #{useYn}
         , #{rmksCts}
         , #{DOC_REG_ID}
         , SYSDATE
         , #{oprtrId} <!-- #{regpsnId} -->
         , SYSDATE
         , #{oprtrId} <!--#{updpsnId}-->
        )
    </insert>


    <!--
    ******************************************************************************
    * UPDATE : 메뉴 수정
    * 작성자 : lee
    * 작성 일자 : 2022-01-27
    ******************************************************************************
    -->
    <update id="updateComMenu" parameterType="HashMap">
        UPDATE SSP_APP.TB_CO_MNU_INFO SET
               MNU_NM = #{mnuNm}
             , MNU_TP_CD = #{mnuTpCd}
             , MNU_LVL_SPR_CD = #{mnuLvlSprCd}
             , PGM_ID = #{pgmId}
             , SRT_SO = #{srtSo}
             , USE_YN = #{useYn}
             , RMKS_CTS = #{rmksCts}
             , DOC_REG_ID = #{docRegId}
             , UPD_DTM = SYSDATE
             , UPDPSN_ID = #{oprtrId}
         WHERE MNU_SEQ = #{mnuSeq}
    </update>

    <!--
    ******************************************************************************
    * UPDATE : 메뉴 수정
    * 작성자 : lee
    * 작성 일자 : 2022-01-27
    ******************************************************************************
    -->
    <update id="deleteComMenu" parameterType="HashMap">
        DELETE FROM SSP_APP.TB_CO_MNU_INFO
          WHERE MNU_SEQ = #{mnuSeq}
            AND MNU_LVL_SPR_CD = #{mnuLvlSprCd}
    </update>


    <!--
    ******************************************************************************
    * SELECT : 메뉴시퀀스 채번
    * 작성자 : lee
    * 작성 일자 : 2022-02-03
    ******************************************************************************
    -->
    <select id="selectMenuSeq" parameterType="HashMap" resultType="Integer">
        SELECT SSP_APP.SQ_CO_MNU_MNG_01.NEXTVAL AS DSP_MST_IDX  FROM DUAL
    </select>



   <!--
    ******************************************************************************
    * SELECT : 즐겨찾기 조회
    * 작성자 : ksy
    * 작성 일자 : 2022-02-17
    ******************************************************************************
    -->
    <resultMap id="MnuFvrtsListResultMap" type="HashMap">
        <result property="MNU_SEQ"         column="MNU_SEQ" />
        <result property="MNU_NM"          column="MNU_NM" />
        <result property="MNU_LVL_SPR_CD"  column="MNU_LVL_SPR_CD" />
        <result property="PGM_ID"          column="PGM_ID" />
        <result property="PGM_NM"          column="PGM_NM" />
        <result property="PGM_CALL_PATH"   column="PGM_CALL_PATH" />
        <result property="UI_ID"           column="UI_ID" />
    </resultMap>
    <select id="selectMnuFvrtsList" parameterType="HashMap" resultMap="MnuFvrtsListResultMap">
		SELECT F.MNU_SEQ
		      ,I.MNU_NM 
		      ,I.MNU_LVL_SPR_CD
		      ,I.PGM_ID       
		      ,P.PGM_NM
			  ,P.PGM_CALL_PATH
			  ,P.UI_ID
		  FROM SSP_APP.TB_CO_MNU_FAVORITE_DTLS  F
		      ,SSP_APP.TB_CO_MNU_INFO           I
		      ,SSP_APP.TB_CO_SYS_PGM_INFO       P
		 WHERE 1=1
		   AND F.MNU_SEQ  = I.MNU_SEQ 
		   AND I.PGM_ID   = P.PGM_ID 
		   AND F.CO_CD    = #{coCd}
		   AND F.OPRTR_ID = #{oprtrId}
		   AND F.USE_YN   = 'Y'   
		   AND I.USE_YN   = 'Y'
		 ORDER BY I.MNU_LVL_SPR_CD
    </select>

    <!--
    ******************************************************************************
    * INSERT : 즐겨찾기 건수
    * 작성자 : ksy
    * 작성 일자 : 2022-02-17
    ******************************************************************************
    -->
	<select id="selectMnuFvrtsCnt" parameterType="hashMap" resultType="Integer">
		/* CoMnuMng.selectMnuFvrtsCnt */
	  	SELECT NVL(COUNT(*), 0)
		  FROM SSP_APP.TB_CO_MNU_FAVORITE_DTLS
		 WHERE 1=1
           AND CO_CD    = #{coCd}
		   AND OPRTR_ID = #{oprtrId}
		   AND MNU_SEQ  = #{mnuSeq}
	</select>

    <!--
    ******************************************************************************
    * INSERT : 즐겨찾기 등록
    * 작성자 : ksy
    * 작성 일자 : 2022-02-17
    ******************************************************************************
    -->
    <insert id="insertMnuFvrts" parameterType="HashMap">
        /* CoMnuMng.insertMnuFvrts */
        INSERT INTO SSP_APP.TB_CO_MNU_FAVORITE_DTLS
        (
           CO_CD
          ,OPRTR_ID
          ,MNU_SEQ
          ,USE_YN
          ,REG_DTM 
          ,REGPSN_ID
          ,UPD_DTM
          ,UPDPSN_ID
        ) VALUES (
           #{coCd}
          ,#{oprtrId}
          ,#{mnuSeq}
          ,'Y'
          ,SYSDATE
          ,'SYSTEM' <!-- #{regpsnId} -->
          ,SYSDATE
          ,'SYSTEM' <!--#{updpsnId}-->
        )
    </insert>

    <!--
    ******************************************************************************
    * UPDATE : 즐겨찾기 삭제
    * 작성자 : ksy
    * 작성 일자 : 2022-02-17
    ******************************************************************************
    -->
    <update id="deleteMnuFvrts" parameterType="HashMap">
        DELETE FROM SSP_APP.TB_CO_MNU_FAVORITE_DTLS
         WHERE CO_CD    = #{coCd}
		   AND OPRTR_ID = #{oprtrId}
		   AND MNU_SEQ  = #{mnuSeq}
    </update>

	<!--
	******************************************************************************
	* SELECT : 메뉴관리 메뉴 목록
	* 작성자 : lee
	* 작성 일자 : 2022-05-19
	******************************************************************************
	-->
	<select id="selectMenuMngList" parameterType="HashMap" resultType="HashMap">
	   /* CoMnuMng.insertComMselectMnuListenu */
		SELECT A.MNU_SEQ
			 , A.MNU_NM
			 , A.MNU_LVL
			 , A.MNU_LVL_SPR_CD
			 , A.MNU_TP_CD
			 , A.HRNK_MNU_SEQ
			 , A.HGST_MNU_SEQ
			 , A.PGM_ID
			 , B.PGM_NM
			 , B.PGM_CALL_PATH
			 , B.PGM_TP_CD
			 , B.THME_DOMN_CD
			 , B.UI_ID
			 , B.MDL_NM
			 , A.RMKS_CTS
			 , A.SRT_SO
			 , A.USE_YN
			 , B.THME_DOMN_CD || '::' || B.UI_ID AS PGM_PATH
			 , A.DOC_REG_ID
			 , CASE WHEN A.REGPSN_ID = 'SYSTEM' THEN 'SYSTEM'
			   ELSE (SELECT '(' || A.REGPSN_ID || ') ' || MAX(OPRTR_NM) FROM TB_CO_MBR_OPRTR_INFO WHERE OPRTR_ID = A.REGPSN_ID) END AS REGPSN_NM	
			 , TO_CHAR(A.REG_DTM, 'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
			 , CASE WHEN A.UPDPSN_ID = 'SYSTEM' THEN 'SYSTEM'
			   ELSE (SELECT '(' || A.UPDPSN_ID || ') ' || MAX(OPRTR_NM) FROM TB_CO_MBR_OPRTR_INFO WHERE OPRTR_ID = A.UPDPSN_ID) END AS UPDPSN_NM
			 , TO_CHAR(A.UPD_DTM, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DTM
			 , 'N' AS CH_SORT
		FROM SSP_APP.TB_CO_MNU_INFO A
		   , SSP_APP.TB_CO_SYS_PGM_INFO B
		WHERE A.PGM_ID = B.PGM_ID (+)
		  <if test=" useYn != '' and useYn != null ">
			  AND A.USE_YN =#{useYn}
		  </if>
	    START WITH HRNK_MNU_SEQ = 0
	  CONNECT BY PRIOR A.MNU_SEQ = HRNK_MNU_SEQ
		ORDER BY SRT_SO
	</select>

	<select id="selectMnuMng" parameterType="HashMap" resultType="HashMap">
		/* CoMnuMng.selectMnuMng */
			SELECT M.MNU_SEQ, M.MNU_NM
			FROM TB_CO_MNU_INFO M
			JOIN TB_CO_SYS_PGM_INFO P 
			ON M.PGM_ID=P.PGM_ID
			WHERE P.PGM_ID=#{pgmId}
	</select>
</mapper>