var G_LoadSecurityJs=!1,G_LoadCompressJs=!1,G_LoadCryptoJs=!1;importScripts("raonkupload.base64.js");importScripts("raonkupload.xhr.js");var G_formfeed="\f",G_vertical="\x0B",G_xhr=null,CryptoJS=null,G_FileEncryptCustom={data:null,isLoaded:!1},G_ExtraData=null,G_BandwidthInfo={beforeSize:0};function makeGuidTagName(a){var b=0,d=(new Date).getTime().toString(32),c;for(c=0;5>c;c++)d+=Math.floor(65535*Math.random()).toString(32);return(a||"o_")+d+(b++).toString(32)}
function upload(a){if("1"==a.security.fileEncrypt||"2"==a.security.fileEncrypt||"2"==a.security.encryptParam)if(null==CryptoJS&&importScripts("aes.js"),"1"==a.customEncrypt.use&&0==G_FileEncryptCustom.isLoaded){G_FileEncryptCustom.data=a.customEncrypt.pluginOptions;for(var b=G_FileEncryptCustom.data.extraModules,d=b.length,c=0;c<d;c++)importScripts(b[c]);G_FileEncryptCustom.isLoaded=!0}if(null==G_xhr||void 0==G_xhr)G_xhr=new XMLHttpRequest;b=a.handlerUrl;b=-1<b.indexOf("?")?b+("&raonk="+makeGuidTagName("urk_")):
b+("?raonk="+makeGuidTagName("urk_"));G_xhr.open("POST",b,a.asyncUpload);var h=a.chunk.size;try{G_xhr.upload.onprogress=function(b){var l=parseInt(b.loaded/b.total*a.chunk.size*1,10),c=G_BandwidthInfo.beforeSize;G_BandwidthInfo.beforeSize=b.loaded;c=b.loaded-c;b.loaded==b.total&&(G_BandwidthInfo.beforeSize=0);self.postMessage({type:"chunkProgress",chunkLoadedSize:l,tickSize:c})}}catch(g){}G_xhr.onreadystatechange=function(){if(4==G_xhr.readyState)if(200==G_xhr.status){var b=RaonKBase64.parseDataFromServer(G_xhr.responseText);
if("[OK]"==b)self.postMessage({type:"progress",paramObj:{uploadedSize:h,workerId:a.workerId,uploadIdx:a.uploadIdx,path:a.path,extraData:G_ExtraData}});else if(0==b.indexOf("[FAIL]")){var b=b.replace("[FAIL]",""),b=RaonKBase64.makeDecryptReponseMessage(b,a.security),b=b.split("|"),l="",c="";0==b.length?c=b[0]:(l=b[0],c=b[1]);self.postMessage({type:"error",code:l,message:c,id:a.id});G_xhr=void 0;self.close()}}else if(400<=G_xhr.status&&600>G_xhr.status||0==G_xhr.status)self.postMessage({type:"error",
code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()};var e="",f=function(){try{G_xhr.send(e),e=void 0}catch(b){self.postMessage({type:"error",code:"C000",message:b.message,workerId:a.workerId}),G_xhr=void 0}},b=""+("kc"+G_formfeed+"c02"+G_vertical),b=b+("k01"+G_formfeed+a.security.encryptParam+G_vertical);0<a.security.fileEncrypt&&(b+="k02"+G_formfeed+a.security.fileEncrypt+G_vertical);b+="k03"+G_formfeed+(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:
a.security.fileIntegrity)+G_vertical;"0"!=a.compress&&(b+="k04"+G_formfeed+3+G_vertical);b+="k05"+G_formfeed+a.resumeUpload+G_vertical;b+="k12"+G_formfeed+a.guid+G_vertical;0==("1"==a.security.customEncrypt.use&&"0"==a.security.customEncrypt.decryptInServer)&&(b+="k19"+G_formfeed+a.startPos+G_vertical);b+="k26"+G_formfeed+a.path;a.cloudInfoUse&&"2"==a.cloudInfoUse&&(b+=G_vertical,b+="k46"+G_formfeed+a.cloudInfoUse+G_vertical,b+="k27"+G_formfeed+a.partNumber+G_vertical,b+="k48"+G_formfeed+a.partSize);
"1"==a.security.customEncrypt.use&&(b+=G_vertical,b+="k49"+G_formfeed+a.security.customEncrypt.use);a.security.customEncrypt.use&&"0"==a.security.customEncrypt.decryptInServer&&(b+=G_vertical,b+="k50"+G_formfeed+"1");b=RaonKBase64.makeEncryptParamFinal(a.security,b);if("undefined"==typeof FormData){var m=makeGuidTagName("----raonk_"),k=function(a){G_xhr&&(G_xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+m),G_xhr.setRequestHeader("RAONK-Encoded","base64"));e=a;f()};try{buildFormData(a,
b,m,k)}catch(n){self.postMessage({type:"error",code:"C001",message:n.message,workerId:a.workerId}),G_xhr=void 0}}else{e=new FormData;e.append(b.name,b.value);var l;if("1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)||"0"!=a.compress||"0"!=a.security.fileEncrypt){l=new FileReaderSync;try{k=l.readAsArrayBuffer(a.chunk),l=void 0}catch(q){l=void 0,self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,
self.close()}}b="";if("1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)){G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0);try{b=D5FileDataIntegrity(k,a.security.keyValue.substring(0,11),!0).toString()}catch(r){self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()}e.append("k25",b)}var p=function(a){e.append("Slice",a);f()};
"0"!=a.compress?makeZipData(a.uploadIdx,k,function(b){0<a.security.fileEncrypt?(l=new FileReaderSync,newData=l.readAsArrayBuffer(b),l=void 0,encryptFileData(newData,a,p)):(e.append("Slice",b),f())}):0<a.security.fileEncrypt?encryptFileData(k,a,p):(e.append("Slice",a.chunk),f())}}self.onmessage=function(a){a=a.data;switch(a.type){case "upload":upload(a.uploadData);break;case "check_formdata":a=!0,"undefined"==typeof FormData&&(a=!1),self.postMessage({type:"check_formdata",isFormDataSupport:a})}};
function buildFormData(a,b,d,c){var h=new FileReaderSync,g=h.readAsDataURL(a.chunk),e=g.match(/,(.*)$/)[1],f,m,k=function(){var a;a=""+("--"+d+'\r\nContent-Disposition: form-data; name="'+b.name+'"');a+="\r\n\r\n";a+=b.value;a+="\r\n";a+="--"+d+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream";a+="\r\n";a+="\r\n";a+=e;a+="\r\n";m&&(a+="--"+d+'\r\nContent-Disposition: form-data; name="k25"',a+="\r\n",a+="\r\n",a+=m,a+="\r\n");
a+="--"+d+"--\r\n";h=g=e=void 0;c(a)};"1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)&&(G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0),f=h.readAsArrayBuffer(a.chunk),m=D5FileDataIntegrity(f,a.security.keyValue,!0).toString());var n=function(a){e=h.readAsDataURL(a).match(/,(.*)$/)[1];k()};"0"!=a.compress?(f||(f=h.readAsArrayBuffer(a.chunk)),makeZipData(a.uploadIdx,f,function(b){0<a.security.fileEncrypt?
encryptFileData(h.readAsArrayBuffer(b),a,n):(e=h.readAsDataURL(b).match(/,(.*)$/)[1],k())})):0<a.security.fileEncrypt?(f||(f=h.readAsArrayBuffer(a.chunk)),encryptFileData(f,a,n)):k()}function makeZipData(a,b,d){G_LoadCompressJs||(importScripts("jszip/jszip.js"),G_LoadCompressJs=!0);var c=new JSZip;c.file(a,b);c.generateAsync({type:"blob",compression:"deflate",compressionOptions:{level:9},comment:"RAONWIZ"},function(a){}).then(function(a){"function"==typeof d&&d(a);c=void 0})}
function encryptFileData(a,b,d){var c;try{c=crypto||msCrypto}catch(h){}var g=b.security.keyValue.substring(0,11),e=16*b.security.fileEncrypt,f=b.workerId;if(G_FileEncryptCustom.data){g={fileArrayBuffer:a,customObject:G_FileEncryptCustom.data.customObject,chunkIdx:b.uploadIdx,isLast:b.isLast,customEncryptConfig:b.security.customEncrypt,updateExtraData:function(b){if(null==G_ExtraData||null==b)G_ExtraData={};for(a in b)G_ExtraData[a]=b[a]},callback:function(a){a=makeBlob(a);d(a)}};try{fileEncryptCustomCommand(g)}catch(m){self.postMessage({type:"error",
code:"C011",message:m.message||m,workerId:f})}}else if(c&&c.subtle){var k=stringToBytes(g),g=new Uint8Array(e);g.set(k);b=c.subtle.importKey("raw",g,{name:"AES-CBC"},!1,["encrypt","decrypt"]);b.then(function(b){var e=new Uint8Array(16);e.set(k);c.subtle.encrypt({name:"AES-CBC",iv:e},b,a).then(function(a){a=makeBlob(a);d(a)})["catch"]=function(a){self.postMessage({type:"error",code:"C011",message:a.message||a,workerId:f})}})["catch"]=function(a){self.postMessage({type:"error",code:"C011",message:a.message||
a,workerId:f})}}else G_LoadCryptoJs||(G_LoadSecurityJs||importScripts("raonkupload.fdi.aes.js"),G_LoadCryptoJs=!0),b=CryptoJS.enc.Utf8.parse(g),b.sigBytes=e,wordArrayData=arrayBufferToWordArray(a),g=CryptoJS.AES.encrypt(wordArrayData,b,{iv:CryptoJS.enc.Utf8.parse(g)}),wordArrayData=void 0,g=makeBlob(convertWordArrayToUint8Array(g.ciphertext)),d(g)}function arrayBufferToBase64(a){var b="";a=new Uint8Array(a);for(var d=a.byteLength,c=0;c<d;c++)b+=String.fromCharCode(a[c]);return btoa(b)}
function stringToBytes(a){for(var b,d,c=[],h=0;h<a.length;h++){b=a.charCodeAt(h);d=[];do d.push(b&255),b>>=8;while(b);c=c.concat(d.reverse())}return c}var makeBlob=function(a){var b=[];b.push(a);return new Blob(b,{type:"application/octet-stream"})};function getTickCount(){return(new Date).getTime()};
